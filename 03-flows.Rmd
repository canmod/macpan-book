# Flow Between States

Here we describe the definition of the basic model of flows among states. Later chapters describe extensions to this basic model, both implemented (TODO) and unimplemented (TODO).

The per-capita rate of flow between any two states can be defined using the `add_rate` function.

```{r echo = FALSE}
sir = init_model(
  params = c(beta = 0.1, gamma = 0.01, N = 100),
  state = c(S = 99, I = 1, R = 0),
  start_date = "2020-03-11",
  end_date = "2020-12-01"
)
```


```{r}
sir = (sir
 %>% add_rate("S", "I", ~ (I) * (beta) * (1/N))
 %>% add_rate("I", "R", ~ (gamma))
)
```

The remainder of this chapter describes the theory of behind these rates, and clarifies what they mean.

## State Flows

The numbers of individuals in each compartment is stored in the state vector, $\mathbf{s}$, which contains one element for each compartment. At each time step, $t$, the state vector is given by $\mathbf{s}(t)$. The relationship between the state vector at successive time steps is given by the following.

$$
\mathbf{s}(t+1) = \mathbf{s}(t) + \mathbf{f}^{\text{in}}(t) - \mathbf{f}^{\text{out}}(t)
$$

where $\mathbf{f}^{\text{in}}$ and $\mathbf{f}^{\text{out}}$ are the inflow and outflow vectors.

Continuing our concrete SIR model example, individuals flow from a box of susceptible individuals to infected to recovered individuals.

$$
S(t+1) = S(t) - \frac{\beta I(t)}{N}S(t)
$$
$$
I(t+1) = I(t) + \frac{\beta I(t)}{N}S(t) - \gamma I(t)
$$
$$
R(t+1) = R(t) + \gamma I(t)
$$

where $\beta$, $\gamma$, and $N$ are the transmission rate and population size parameters.

In this model the inflow to the $S$ box is zero and the outflow from $R$ is also zero. Therefore we can express this model in general terms as the following.

$$
\mathbf{s} =
\begin{bmatrix}
S \\ I \\ R
\end{bmatrix}
$$
$$
\mathbf{f}^{\text{in}} = 
\begin{bmatrix}
0 \\ \frac{\beta I S}{N} \\ \gamma I
\end{bmatrix}
$$
$$
\mathbf{f}^{\text{out}} = 
\begin{bmatrix}
\frac{\beta I S}{N} \\ \gamma I \\ 0
\end{bmatrix}
$$

## Flow Matrix

Note that the outflow from $S$ and inflow to $I$ in the previous example has an identical magnitude. This is a common pattern in compartmental models. Many outflows are balanced perfectly by an associated inflow, to model individuals flowing from one compartment to another. McMasterPandemic assumes this balancing of flows to be the default situation, and therefore expresses both inflows and outflows in terms of an $n$ by $n$ flow matrix, $\mathbf{F}$, that only requires specifying a single expression for each inflow-outflow pair. The element in the $i$th row and $j$th column of the flow matrix gives the flow from state $i$ to state $j$. The default inflow and outflow vectors can therefore be computed as the column sums and row sums respectively. Continuing the SI model example, we have the following flow matrix.

$$
\mathbf{F} = 
\begin{bmatrix}
0 & \frac{\beta I}{N}S & 0 \\
0 & 0 & \gamma I \\
0 & 0 & 0 \\
\end{bmatrix}
$$

There are times however where one wants a particular flow from one state to another to include only the inflow component and not the outflow. For example in cases where death removes individuals from the population. We consider this and other examples of asymmetric flow in later chapters (TODO).

## Rate Matrix

In modelling it is often more convenient to define per-capita rates of flow between compartments rather than total flow. The rate matrix, $\mathbf{M}$, contains these per-capita rates. The elements, $F_{ij}$, of the flow matrix can be computed from the rate matrix and the state vector as follows.

$$
F_{ij} = M_{ij}s_i
$$

The rate matrix for the SI model is given by the following expression.

$$
\mathbf{M} = 
\begin{bmatrix}
0 & \frac{\beta I}{N} & 0 \\
0 & 0 & \gamma \\
0 & 0 & 0 
\end{bmatrix}
$$

The elements of the rate matrix are determined by expressions involving elements of the state vector and parameters, which we collect into a paramter vector, $\mathbf{\theta}$. For the SI model $\mathbf{\theta}$ contains two parameters.

$$
\mathbf{\theta} = \begin{bmatrix}
\beta \\
\gamma \\
N
\end{bmatrix}
$$

## Rate Matrix Dependence on State Variables and Parameters

Currently it is not possible to specify elements of the rate matrix as arbitrary arithmetic expressions involving state variables and parameters -- although we plan to add this functionality. However, there is a reasonable degree of flexibility.

Each element of the rate matrix can be any expression that obeys the following rules. Any element, $x$, of either the parameter or state vector can be used to define a *factor* in one of the following three forms.

-   Identity: $x$
-   Complement: $1-x$
-   Inverse: $1/x$

We collect these user-defined factors into a factor vector, $\mathbf{y}$. Factors can be repeated in $\mathbf{y}$ if required. Any number of factors can be multiplied together using `*` to produce a *product*. Any number of factors and products can be added together using `+`.

There is the following higher level nested structure associated with the factor vector, $\mathbf{y}$.

-   All factors associated with the, $i$th, non-zero rate matrix element, $M_{(i)}$, are grouped together in a contiguous block within $\mathbf{y}$
-   Within the $i$th block, all factors associated with the $j$th product ($j = 1 ... n_i$) in that block are grouped together in a contiguous sub-block
-   Within the $i,j$th sub-block, all factors are given an index, $k = 1 ... m_{ij}$

With these definitions, the dependence of any non-zero rate matrix element on the parameters and state variables is given by the following expression.

$$
M_{(i)} = \sum_{j=1}^{n_i} \prod_{k=1}^{m_{ij}} y_{ijk}
$$

where $y_{ijk}$ is the $k$th factor associated with the $j$th product associated with the $i$th non-zero rate matrix element.

```{r echo = FALSE}
rs = rate_summary(sir)
rownames(rs) = NULL
names(rs) = sub("_", "-", names(rs))
knitr::kable(rs)
```


McMasterPandemic is designed to be modular allow multiple definitions of valid expressions for the rate matrix. In later chapters we describe this possibility (TODO).

## Next Steps
