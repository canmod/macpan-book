<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Convergence | Using McMasterPandemic</title>
  <meta name="description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Convergence | Using McMasterPandemic" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="github-repo" content="canmod/macpan-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Convergence | Using McMasterPandemic" />
  
  <meta name="twitter:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  

<meta name="author" content="Steve Walker" />


<meta name="date" content="2022-09-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="calibration.html"/>
<link rel="next" href="time-varying-parameters.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
<script src="libs/vis-9.1.0/vis-network.min.js"></script>
<script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">McMasterPandemic</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Fast and Flexible Modelling with McMasterPandemic</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#history-and-motivation"><i class="fa fa-check"></i><b>1.1</b> History and Motivation</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#covid-19-forecasts"><i class="fa fa-check"></i><b>1.1.1</b> COVID-19 Forecasts</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#calibration-to-data"><i class="fa fa-check"></i><b>1.1.2</b> Calibration to data</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#speed"><i class="fa fa-check"></i><b>1.1.3</b> Speed</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#model-extensibility"><i class="fa fa-check"></i><b>1.1.4</b> Model Extensibility</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dependencies"><i class="fa fa-check"></i><b>1.3</b> Dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#generalized-model-at-a-glance"><i class="fa fa-check"></i><b>1.4</b> Generalized Model at a Glance</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#vision-and-direction"><i class="fa fa-check"></i><b>1.5</b> Vision and Direction</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="model-initialization.html"><a href="model-initialization.html"><i class="fa fa-check"></i><b>2</b> Model Initialization</a><ul>
<li class="chapter" data-level="2.1" data-path="model-initialization.html"><a href="model-initialization.html#initial-parameter-vector"><i class="fa fa-check"></i><b>2.1</b> Initial Parameter Vector</a></li>
<li class="chapter" data-level="2.2" data-path="model-initialization.html"><a href="model-initialization.html#initial-state-vector"><i class="fa fa-check"></i><b>2.2</b> Initial State Vector</a></li>
<li class="chapter" data-level="2.3" data-path="model-initialization.html"><a href="model-initialization.html#start-and-end-date"><i class="fa fa-check"></i><b>2.3</b> Start and End Date</a></li>
<li class="chapter" data-level="2.4" data-path="model-initialization.html"><a href="model-initialization.html#next-steps"><i class="fa fa-check"></i><b>2.4</b> Next Steps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="flow-between-states.html"><a href="flow-between-states.html"><i class="fa fa-check"></i><b>3</b> Flow Between States</a><ul>
<li class="chapter" data-level="3.1" data-path="flow-between-states.html"><a href="flow-between-states.html#state-flows"><i class="fa fa-check"></i><b>3.1</b> State Flows</a></li>
<li class="chapter" data-level="3.2" data-path="flow-between-states.html"><a href="flow-between-states.html#flow-matrix"><i class="fa fa-check"></i><b>3.2</b> Flow Matrix</a></li>
<li class="chapter" data-level="3.3" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix"><i class="fa fa-check"></i><b>3.3</b> Rate Matrix</a></li>
<li class="chapter" data-level="3.4" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters"><i class="fa fa-check"></i><b>3.4</b> Rate Matrix Dependence on State Variables and Parameters</a></li>
<li class="chapter" data-level="3.5" data-path="flow-between-states.html"><a href="flow-between-states.html#connections-with-classic-mcmasterpandemic"><i class="fa fa-check"></i><b>3.5</b> Connections with Classic McMasterPandemic</a></li>
<li class="chapter" data-level="3.6" data-path="flow-between-states.html"><a href="flow-between-states.html#topological-sort"><i class="fa fa-check"></i><b>3.6</b> Topological Sort</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>4</b> Simulation</a><ul>
<li class="chapter" data-level="4.1" data-path="simulation.html"><a href="simulation.html#observation-error"><i class="fa fa-check"></i><b>4.1</b> Observation Error</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>5</b> Calibration</a><ul>
<li class="chapter" data-level="5.1" data-path="calibration.html"><a href="calibration.html#calibrating-with-observation-error"><i class="fa fa-check"></i><b>5.1</b> Calibrating with Observation Error</a></li>
<li class="chapter" data-level="5.2" data-path="calibration.html"><a href="calibration.html#loss-function-theory"><i class="fa fa-check"></i><b>5.2</b> Loss Function Theory</a><ul>
<li class="chapter" data-level="5.2.1" data-path="calibration.html"><a href="calibration.html#negative-binomial"><i class="fa fa-check"></i><b>5.2.1</b> Negative Binomial</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="convergence.html"><a href="convergence.html"><i class="fa fa-check"></i><b>6</b> Convergence</a></li>
<li class="chapter" data-level="7" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html"><i class="fa fa-check"></i><b>7</b> Time Varying Parameters</a><ul>
<li class="chapter" data-level="7.1" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#model-of-piece-wise-time-variation"><i class="fa fa-check"></i><b>7.1</b> Model of Piece-Wise Time-Variation</a></li>
<li class="chapter" data-level="7.2" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#calibrating-time-variation-schedules"><i class="fa fa-check"></i><b>7.2</b> Calibrating Time-Variation Schedules</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-variables.html"><a href="other-variables.html"><i class="fa fa-check"></i><b>8</b> Other Variables</a><ul>
<li class="chapter" data-level="8.1" data-path="other-variables.html"><a href="other-variables.html#intermediate-results"><i class="fa fa-check"></i><b>8.1</b> Intermediate Results</a><ul>
<li class="chapter" data-level="8.1.1" data-path="other-variables.html"><a href="other-variables.html#sums-of-state-variables-and-parameters"><i class="fa fa-check"></i><b>8.1.1</b> Sums of State Variables and Parameters</a></li>
<li class="chapter" data-level="8.1.2" data-path="other-variables.html"><a href="other-variables.html#factrs"><i class="fa fa-check"></i><b>8.1.2</b> Factrs</a></li>
<li class="chapter" data-level="8.1.3" data-path="other-variables.html"><a href="other-variables.html#power-laws"><i class="fa fa-check"></i><b>8.1.3</b> Power Laws</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="other-variables.html"><a href="other-variables.html#additional-variables-in-the-simulation-history"><i class="fa fa-check"></i><b>8.2</b> Additional Variables in the Simulation History</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-variables.html"><a href="other-variables.html#simulation-history-expressions"><i class="fa fa-check"></i><b>8.2.1</b> Simulation History Expressions</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-variables.html"><a href="other-variables.html#lagged-differencing"><i class="fa fa-check"></i><b>8.2.2</b> Lagged Differencing</a></li>
<li class="chapter" data-level="8.2.3" data-path="other-variables.html"><a href="other-variables.html#convolutions"><i class="fa fa-check"></i><b>8.2.3</b> Convolutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html"><i class="fa fa-check"></i><b>9</b> Ensemble Forecasts</a><ul>
<li class="chapter" data-level="9.1" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html#time-varying-ensemble-forecasts"><i class="fa fa-check"></i><b>9.1</b> Time-Varying Ensemble Forecasts</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>10</b> Vectors</a></li>
<li class="chapter" data-level="11" data-path="hazard-smoothing.html"><a href="hazard-smoothing.html"><i class="fa fa-check"></i><b>11</b> Hazard Smoothing</a></li>
<li class="chapter" data-level="12" data-path="state-initialization.html"><a href="state-initialization.html"><i class="fa fa-check"></i><b>12</b> State Initialization</a></li>
<li class="chapter" data-level="13" data-path="outflows.html"><a href="outflows.html"><i class="fa fa-check"></i><b>13</b> Outflows</a><ul>
<li class="chapter" data-level="13.1" data-path="outflows.html"><a href="outflows.html#accumulators"><i class="fa fa-check"></i><b>13.1</b> Accumulators</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="tmb-engine.html"><a href="tmb-engine.html"><i class="fa fa-check"></i><b>14</b> TMB Engine</a></li>
<li class="chapter" data-level="15" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>15</b> Examples</a><ul>
<li class="chapter" data-level="15.1" data-path="examples.html"><a href="examples.html#hello-world-simulating-an-sir-model"><i class="fa fa-check"></i><b>15.1</b> Hello World: Simulating an SIR Model</a></li>
<li class="chapter" data-level="15.2" data-path="examples.html"><a href="examples.html#si"><i class="fa fa-check"></i><b>15.2</b> SI</a></li>
<li class="chapter" data-level="15.3" data-path="examples.html"><a href="examples.html#seir"><i class="fa fa-check"></i><b>15.3</b> SEIR</a></li>
<li class="chapter" data-level="15.4" data-path="examples.html"><a href="examples.html#structure-two-strain-sir"><i class="fa fa-check"></i><b>15.4</b> Structure: Two-Strain SIR</a></li>
<li class="chapter" data-level="15.5" data-path="examples.html"><a href="examples.html#erlang-seir"><i class="fa fa-check"></i><b>15.5</b> Erlang SEIR</a></li>
<li class="chapter" data-level="15.6" data-path="examples.html"><a href="examples.html#sirv"><i class="fa fa-check"></i><b>15.6</b> SIRV</a></li>
<li class="chapter" data-level="15.7" data-path="examples.html"><a href="examples.html#variolation-model"><i class="fa fa-check"></i><b>15.7</b> Variolation model</a></li>
<li class="chapter" data-level="15.8" data-path="examples.html"><a href="examples.html#seird"><i class="fa fa-check"></i><b>15.8</b> SEIRD</a></li>
<li class="chapter" data-level="15.9" data-path="examples.html"><a href="examples.html#covid-seir"><i class="fa fa-check"></i><b>15.9</b> Covid SEIR</a></li>
<li class="chapter" data-level="15.10" data-path="examples.html"><a href="examples.html#bc-covid-omicron"><i class="fa fa-check"></i><b>15.10</b> BC Covid Omicron</a></li>
<li class="chapter" data-level="15.11" data-path="examples.html"><a href="examples.html#classic-mcmasterpandemic"><i class="fa fa-check"></i><b>15.11</b> Classic McMasterPandemic</a></li>
<li class="chapter" data-level="15.12" data-path="examples.html"><a href="examples.html#granich-hiv-model"><i class="fa fa-check"></i><b>15.12</b> Granich HIV Model</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="troubleshooting.html"><a href="troubleshooting.html"><i class="fa fa-check"></i><b>16</b> Troubleshooting</a><ul>
<li class="chapter" data-level="16.1" data-path="troubleshooting.html"><a href="troubleshooting.html#nan-valued-objective-function"><i class="fa fa-check"></i><b>16.1</b> NaN-Valued Objective Function</a><ul>
<li class="chapter" data-level="16.1.1" data-path="troubleshooting.html"><a href="troubleshooting.html#simulated-time-series-close-to-zero"><i class="fa fa-check"></i><b>16.1.1</b> Simulated time-series close to zero</a></li>
<li class="chapter" data-level="16.1.2" data-path="troubleshooting.html"><a href="troubleshooting.html#negative-rate-matrix-elements"><i class="fa fa-check"></i><b>16.1.2</b> Negative rate matrix elements</a></li>
<li class="chapter" data-level="16.1.3" data-path="troubleshooting.html"><a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters"><i class="fa fa-check"></i><b>16.1.3</b> Optimizer tries very large dispersion parameters</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="troubleshooting.html"><a href="troubleshooting.html#non-positive-definite-covariance-matrix"><i class="fa fa-check"></i><b>16.2</b> Non-Positive Definite Covariance Matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Using McMasterPandemic</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="convergence" class="section level1 hasAnchor">
<h1><span class="header-section-number">6</span> Convergence<a href="convergence.html#convergence" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In the last chapter we showed how to fit a simple SIR model to data, and things went relatively smoothly. Now we modify the fitting problem just slightly to illustrate how things can get more challenging pretty quickly. In particular we simulate all three state variables and give them different levels of observation error by specifying different values for the negative binomial dispersion parameter.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="convergence.html#cb46-1"></a><span class="kw">set.seed</span>(1L)</span>
<span id="cb46-2"><a href="convergence.html#cb46-2"></a>more_noisy_data =<span class="st"> </span>(sir_with_obs_err</span>
<span id="cb46-3"><a href="convergence.html#cb46-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_params</span>(<span class="kw">c</span>(</span>
<span id="cb46-4"><a href="convergence.html#cb46-4"></a>    <span class="dt">nb_disp_S =</span> <span class="fl">0.1</span>,</span>
<span id="cb46-5"><a href="convergence.html#cb46-5"></a>    <span class="dt">nb_disp_I =</span> <span class="fl">1e4</span>,</span>
<span id="cb46-6"><a href="convergence.html#cb46-6"></a>    <span class="dt">nb_disp_R =</span> <span class="dv">1</span></span>
<span id="cb46-7"><a href="convergence.html#cb46-7"></a>  ))</span>
<span id="cb46-8"><a href="convergence.html#cb46-8"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">simulation_history</span>(<span class="dt">include_initial_date =</span> <span class="ot">FALSE</span>, <span class="dt">obs_error =</span> <span class="ot">TRUE</span>)</span>
<span id="cb46-9"><a href="convergence.html#cb46-9"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>S_to_I)</span>
<span id="cb46-10"><a href="convergence.html#cb46-10"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Date, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb46-11"><a href="convergence.html#cb46-11"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">var =</span> <span class="kw">factor</span>(var, <span class="kw">topological_sort</span>(sir)))</span>
<span id="cb46-12"><a href="convergence.html#cb46-12"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date =</span> Date)</span>
<span id="cb46-13"><a href="convergence.html#cb46-13"></a>)</span>
<span id="cb46-14"><a href="convergence.html#cb46-14"></a>(<span class="kw">ggplot</span>(more_noisy_data)</span>
<span id="cb46-15"><a href="convergence.html#cb46-15"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var, <span class="dt">scales =</span> <span class="st">&#39;free&#39;</span>)</span>
<span id="cb46-16"><a href="convergence.html#cb46-16"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date, value))</span>
<span id="cb46-17"><a href="convergence.html#cb46-17"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/harder_sir_opt_problem-1.png" width="672" /></p>
<p>With these new simulated data we update the <code>flexmodel</code> object that we were previously using for calibration with the more challenging noisy data. Note also that we declare more dispersion parameters to be optimized, because the data now include all three compartments.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="convergence.html#cb47-1"></a>sir_harder_to_calibrate =<span class="st"> </span>(sir_to_calibrate</span>
<span id="cb47-2"><a href="convergence.html#cb47-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span>reset_error_dist</span>
<span id="cb47-3"><a href="convergence.html#cb47-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_observed</span>(more_noisy_data)</span>
<span id="cb47-4"><a href="convergence.html#cb47-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_opt_params</span>(</span>
<span id="cb47-5"><a href="convergence.html#cb47-5"></a>    log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb47-6"><a href="convergence.html#cb47-6"></a>    log_nb_disp_S <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb47-7"><a href="convergence.html#cb47-7"></a>    log_nb_disp_I <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb47-8"><a href="convergence.html#cb47-8"></a>    log_nb_disp_R <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>)</span>
<span id="cb47-9"><a href="convergence.html#cb47-9"></a>  )</span>
<span id="cb47-10"><a href="convergence.html#cb47-10"></a>)</span></code></pre></div>
<p>Fitting this model using the defaults results in the following errors from the optimizer.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="convergence.html#cb48-1"></a>sir_hard_attempt_<span class="dv">1</span> =<span class="st"> </span><span class="kw">calibrate_flexmodel</span>(sir_harder_to_calibrate)</span></code></pre></div>
<pre><code>## Error in optim(par = c(log_beta = 0, log_nb_disp_S = 0, log_nb_disp_I = 0,  : 
##   initial value in &#39;vmmin&#39; is not finite</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="convergence.html#cb50-1"></a><span class="kw">convergence_info</span>(sir_hard_attempt_<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Error in optim(par = c(log_beta = 0, log_nb_disp_S = 0, log_nb_disp_I = 0,  : \n  initial value in &#39;vmmin&#39; is not finite\n&quot;
## attr(,&quot;class&quot;)
## [1] &quot;try-error&quot;
## attr(,&quot;condition&quot;)
## &lt;simpleError in optim(par = c(log_beta = 0, log_nb_disp_S = 0, log_nb_disp_I = 0, log_nb_disp_R = 0), fn = function (p) {    if (browse_obj)         browser()    l &lt;- relist2(p, template)    names(p) &lt;- nstart[order(oo)]    l[nfix] &lt;- fixed    if (vecpar) {        l &lt;- namedrop(l[nfull])        l &lt;- unlist(l)        args &lt;- list(l)        args &lt;- c(list(l), args.in.data)    }    else {        args &lt;- c(l, args.in.data)    }    if (namedrop_args)         args &lt;- namedrop(args)    do.call(&quot;minuslogl&quot;, args)}, method = &quot;BFGS&quot;, hessian = FALSE, gr = function (p) {    if (browse_obj)         browser()    l &lt;- relist2(p, template)    names(p) &lt;- nstart[order(oo)]    l[nfix] &lt;- fixed    if (vecpar) {        l &lt;- namedrop(l[nfull])        l &lt;- unlist(l)        args &lt;- list(l)        args &lt;- c(list(l), args.in.data)    }    else {        args &lt;- c(l, args.in.data)    }    v &lt;- do.call(&quot;gr&quot;, args)    if (is.null(names(v))) {        if (length(v) == length(l) &amp;&amp; !is.null(tt &lt;- names(l))) {            vnames &lt;- tt        }        else if (length(v) == length(p) &amp;&amp; !is.null(tt &lt;- names(p))) {            vnames &lt;- tt        }        else if (!is.null(tt &lt;- parnames(minuslogl))) {            vnames &lt;- tt        }        else vnames &lt;- names(formals(minuslogl))        if (length(vnames) != length(v))             stop(&quot;name/length mismatch in gradient function&quot;)        names(v) &lt;- vnames    }    return(v[!names(v) %in% nfix])}, control = list(), lower = -Inf, upper = Inf): initial value in &#39;vmmin&#39; is not finite&gt;</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="convergence.html#cb52-1"></a>sir_hard_attempt_<span class="dv">2</span> =<span class="st"> </span><span class="kw">calibrate_flexmodel</span>(</span>
<span id="cb52-2"><a href="convergence.html#cb52-2"></a>  sir_harder_to_calibrate,</span>
<span id="cb52-3"><a href="convergence.html#cb52-3"></a>  <span class="dt">optimizer =</span> <span class="st">&#39;nlminb&#39;</span></span>
<span id="cb52-4"><a href="convergence.html#cb52-4"></a>)</span></code></pre></div>
<pre><code>## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation

## Warning in nlminb(start = start, objective = objectivefunction, hessian =
## NULL, : NA/NaN function evaluation</code></pre>
<pre><code>## Warning in bbmle::mle2(obj_fun$fn, start_par, gr = obj_fun$gr, parnames =
## names(start_par), : couldn&#39;t invert Hessian</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="convergence.html#cb55-1"></a><span class="kw">convergence_info</span>(sir_hard_attempt_<span class="dv">2</span>)</span></code></pre></div>
<pre><code>## $par
##      log_beta log_nb_disp_S log_nb_disp_I log_nb_disp_R 
##             0             0             0             0 
## 
## $objective
## [1] Inf
## 
## $convergence
## [1] 0
## 
## $iterations
## [1] 1
## 
## $evaluations
## function gradient 
##        2        4 
## 
## $message
## [1] &quot;X-convergence (3)&quot;
## 
## $hessian
##          [,1] [,2]     [,3]     [,4]
## [1,]      NaN  NaN      NaN      NaN
## [2,]      NaN  NaN      NaN      NaN
## [3,] 13.64742    0 102.8402   0.0000
## [4,] 13.27857    0   0.0000 189.5047
## 
## $maxgrad
## [1] NaN
## 
## $eratio
## [1] NA</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="convergence.html#cb57-1"></a>sir_hard_attempt_<span class="dv">3</span> =<span class="st"> </span>(sir_harder_to_calibrate</span>
<span id="cb57-2"><a href="convergence.html#cb57-2"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_opt_params</span>(</span>
<span id="cb57-3"><a href="convergence.html#cb57-3"></a>    log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb57-4"><a href="convergence.html#cb57-4"></a>    log_nb_disp_S <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb57-5"><a href="convergence.html#cb57-5"></a>    log_nb_disp_I <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb57-6"><a href="convergence.html#cb57-6"></a>    log_nb_disp_R <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>)</span>
<span id="cb57-7"><a href="convergence.html#cb57-7"></a>  )</span>
<span id="cb57-8"><a href="convergence.html#cb57-8"></a>  <span class="op">%&gt;%</span><span class="st"> </span>calibrate_flexmodel</span>
<span id="cb57-9"><a href="convergence.html#cb57-9"></a>)</span>
<span id="cb57-10"><a href="convergence.html#cb57-10"></a><span class="kw">convergence_info</span>(sir_hard_attempt_<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## $par
##      log_beta log_nb_disp_S log_nb_disp_I log_nb_disp_R 
##    -2.3075737    -2.1004227     9.0642536    -0.1010736 
## 
## $value
## [1] 2294.749
## 
## $counts
## function gradient 
##       75       28 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##               [,1]      [,2]         [,3]       [,4]
## [1,]  1.002927e+04 -19.31947 -0.056975984  -5.624261
## [2,] -1.931947e+01  39.92026  0.000000000   0.000000
## [3,] -5.696362e-02   0.00000  0.003400036   0.000000
## [4,] -5.624261e+00   0.00000  0.000000000 129.828358
## 
## $maxgrad
## [1] 0.005206376
## 
## $eratio
## [1] 3.389777e-07</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="convergence.html#cb59-1"></a>sir_hard_attempt_<span class="dv">4</span> =<span class="st"> </span><span class="kw">profile</span>(<span class="kw">opt_obj</span>(sir_hard_attempt_<span class="dv">3</span>))</span></code></pre></div>
<pre><code>## Profiling has found a better solution,so original fit had not converged:</code></pre>
<pre><code>## (new deviance=3633, old deviance=4589, diff=-956.8)</code></pre>
<pre><code>## Returning better fit ...</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="convergence.html#cb63-1"></a>sir_hard_attempt_<span class="dv">4</span><span class="op">@</span>details</span></code></pre></div>
<pre><code>## $par
##      log_beta log_nb_disp_S log_nb_disp_R 
##    -2.2471694    -2.1075732    -0.1006872 
## 
## $value
## [1] 1816.368
## 
## $counts
## function gradient 
##       84        9 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##      [,1] [,2] [,3]
## [1,]   NA   NA   NA
## [2,]   NA   NA   NA
## [3,]   NA   NA   NA
## 
## $maxgrad
## [1] 574.4543</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="convergence.html#cb65-1"></a><span class="kw">plot</span>(<span class="kw">slice</span>(sir_hard_attempt_<span class="dv">4</span>))</span></code></pre></div>
<pre><code>## log_beta 
## log_nb_disp_S 
## log_nb_disp_I.log_nb_disp_I 
## log_nb_disp_R</code></pre>
<p><img src="_main_files/figure-html/fit_harder_to_calibrate_model_3-1.png" width="672" /></p>
<p>TODO: plot profiles and slices</p>
<p>TODO: add ability to use auto-diff hessian with bbmle (currently not even possible with optimizer = ‘nlminb’ because this is a bbmle::mle2 argument and bbmle::mle2 doesn’t allow use-supplied hessian functions, at least by default)</p>
<p>TODO: add functionality to the package for updating starting values in a more convenient manner than update_opt_params. maybe even a way to modify the starting values based on a vector giving the argument to the objective function. this would allow one to chain together optimization runs.</p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="calibration.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="time-varying-parameters.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/canmod/macpan-book/edit/main/05-convergence.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
