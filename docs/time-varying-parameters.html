<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Time Varying Parameters | Generalized McMasterPandemic</title>
  <meta name="description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Time Varying Parameters | Generalized McMasterPandemic" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="github-repo" content="canmod/macpan-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Time Varying Parameters | Generalized McMasterPandemic" />
  
  <meta name="twitter:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  

<meta name="author" content="Steve Walker" />


<meta name="date" content="2022-08-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="convergence.html"/>
<link rel="next" href="other-variables.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
<script src="libs/vis-9.1.0/vis-network.min.js"></script>
<script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">McMasterPandemic</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Fast and Flexible Modelling with McMasterPandemic</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#history-and-motivation"><i class="fa fa-check"></i><b>1.1</b> History and Motivation</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#covid-19-forecasts"><i class="fa fa-check"></i><b>1.1.1</b> COVID-19 Forecasts</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#calibration-to-data"><i class="fa fa-check"></i><b>1.1.2</b> Calibration to data</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#speed"><i class="fa fa-check"></i><b>1.1.3</b> Speed</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#model-extensibility"><i class="fa fa-check"></i><b>1.1.4</b> Model Extensibility</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dependencies"><i class="fa fa-check"></i><b>1.3</b> Dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#generalized-model-at-a-glance"><i class="fa fa-check"></i><b>1.4</b> Generalized Model at a Glance</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#vision-and-direction"><i class="fa fa-check"></i><b>1.5</b> Vision and Direction</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="model-initialization.html"><a href="model-initialization.html"><i class="fa fa-check"></i><b>2</b> Model Initialization</a><ul>
<li class="chapter" data-level="2.1" data-path="model-initialization.html"><a href="model-initialization.html#initial-parameter-vector"><i class="fa fa-check"></i><b>2.1</b> Initial Parameter Vector</a></li>
<li class="chapter" data-level="2.2" data-path="model-initialization.html"><a href="model-initialization.html#initial-state-vector"><i class="fa fa-check"></i><b>2.2</b> Initial State Vector</a></li>
<li class="chapter" data-level="2.3" data-path="model-initialization.html"><a href="model-initialization.html#start-and-end-date"><i class="fa fa-check"></i><b>2.3</b> Start and End Date</a></li>
<li class="chapter" data-level="2.4" data-path="model-initialization.html"><a href="model-initialization.html#next-steps"><i class="fa fa-check"></i><b>2.4</b> Next Steps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="flow-between-states.html"><a href="flow-between-states.html"><i class="fa fa-check"></i><b>3</b> Flow Between States</a><ul>
<li class="chapter" data-level="3.1" data-path="flow-between-states.html"><a href="flow-between-states.html#state-flows"><i class="fa fa-check"></i><b>3.1</b> State Flows</a></li>
<li class="chapter" data-level="3.2" data-path="flow-between-states.html"><a href="flow-between-states.html#flow-matrix"><i class="fa fa-check"></i><b>3.2</b> Flow Matrix</a></li>
<li class="chapter" data-level="3.3" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix"><i class="fa fa-check"></i><b>3.3</b> Rate Matrix</a></li>
<li class="chapter" data-level="3.4" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters"><i class="fa fa-check"></i><b>3.4</b> Rate Matrix Dependence on State Variables and Parameters</a></li>
<li class="chapter" data-level="3.5" data-path="flow-between-states.html"><a href="flow-between-states.html#connections-with-classic-mcmasterpandemic"><i class="fa fa-check"></i><b>3.5</b> Connections with Classic McMasterPandemic</a></li>
<li class="chapter" data-level="3.6" data-path="flow-between-states.html"><a href="flow-between-states.html#topological-sort"><i class="fa fa-check"></i><b>3.6</b> Topological Sort</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>4</b> Simulation</a><ul>
<li class="chapter" data-level="4.1" data-path="simulation.html"><a href="simulation.html#observation-error"><i class="fa fa-check"></i><b>4.1</b> Observation Error</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>5</b> Calibration</a><ul>
<li class="chapter" data-level="5.1" data-path="calibration.html"><a href="calibration.html#calibrating-with-observation-error"><i class="fa fa-check"></i><b>5.1</b> Calibrating with Observation Error</a></li>
<li class="chapter" data-level="5.2" data-path="calibration.html"><a href="calibration.html#loss-function-theory"><i class="fa fa-check"></i><b>5.2</b> Loss Function Theory</a><ul>
<li class="chapter" data-level="5.2.1" data-path="calibration.html"><a href="calibration.html#negative-binomial"><i class="fa fa-check"></i><b>5.2.1</b> Negative Binomial</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="convergence.html"><a href="convergence.html"><i class="fa fa-check"></i><b>6</b> Convergence</a></li>
<li class="chapter" data-level="7" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html"><i class="fa fa-check"></i><b>7</b> Time Varying Parameters</a><ul>
<li class="chapter" data-level="7.1" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#model-of-piece-wise-time-variation"><i class="fa fa-check"></i><b>7.1</b> Model of Piece-Wise Time-Variation</a></li>
<li class="chapter" data-level="7.2" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#calibrating-time-variation-schedules"><i class="fa fa-check"></i><b>7.2</b> Calibrating Time-Variation Schedules</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-variables.html"><a href="other-variables.html"><i class="fa fa-check"></i><b>8</b> Other Variables</a><ul>
<li class="chapter" data-level="8.1" data-path="other-variables.html"><a href="other-variables.html#intermediate-results"><i class="fa fa-check"></i><b>8.1</b> Intermediate Results</a><ul>
<li class="chapter" data-level="8.1.1" data-path="other-variables.html"><a href="other-variables.html#sums-of-state-variables-and-parameters"><i class="fa fa-check"></i><b>8.1.1</b> Sums of State Variables and Parameters</a></li>
<li class="chapter" data-level="8.1.2" data-path="other-variables.html"><a href="other-variables.html#factrs"><i class="fa fa-check"></i><b>8.1.2</b> Factrs</a></li>
<li class="chapter" data-level="8.1.3" data-path="other-variables.html"><a href="other-variables.html#power-laws"><i class="fa fa-check"></i><b>8.1.3</b> Power Laws</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="other-variables.html"><a href="other-variables.html#additional-variables-in-the-simulation-history"><i class="fa fa-check"></i><b>8.2</b> Additional Variables in the Simulation History</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-variables.html"><a href="other-variables.html#simulation-history-expressions"><i class="fa fa-check"></i><b>8.2.1</b> Simulation History Expressions</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-variables.html"><a href="other-variables.html#lagged-differencing"><i class="fa fa-check"></i><b>8.2.2</b> Lagged Differencing</a></li>
<li class="chapter" data-level="8.2.3" data-path="other-variables.html"><a href="other-variables.html#convolutions"><i class="fa fa-check"></i><b>8.2.3</b> Convolutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html"><i class="fa fa-check"></i><b>9</b> Ensemble Forecasts</a><ul>
<li class="chapter" data-level="9.1" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html#time-varying-ensemble-forecasts"><i class="fa fa-check"></i><b>9.1</b> Time-Varying Ensemble Forecasts</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>10</b> Vectors</a></li>
<li class="chapter" data-level="11" data-path="hazard-smoothing.html"><a href="hazard-smoothing.html"><i class="fa fa-check"></i><b>11</b> Hazard Smoothing</a></li>
<li class="chapter" data-level="12" data-path="state-initialization.html"><a href="state-initialization.html"><i class="fa fa-check"></i><b>12</b> State Initialization</a></li>
<li class="chapter" data-level="13" data-path="outflows.html"><a href="outflows.html"><i class="fa fa-check"></i><b>13</b> Outflows</a><ul>
<li class="chapter" data-level="13.1" data-path="outflows.html"><a href="outflows.html#accumulators"><i class="fa fa-check"></i><b>13.1</b> Accumulators</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="tmb-engine.html"><a href="tmb-engine.html"><i class="fa fa-check"></i><b>14</b> TMB Engine</a></li>
<li class="chapter" data-level="15" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>15</b> Examples</a><ul>
<li class="chapter" data-level="15.1" data-path="examples.html"><a href="examples.html#hello-world-simulating-an-sir-model"><i class="fa fa-check"></i><b>15.1</b> Hello World: Simulating an SIR Model</a></li>
<li class="chapter" data-level="15.2" data-path="examples.html"><a href="examples.html#si"><i class="fa fa-check"></i><b>15.2</b> SI</a></li>
<li class="chapter" data-level="15.3" data-path="examples.html"><a href="examples.html#seir"><i class="fa fa-check"></i><b>15.3</b> SEIR</a></li>
<li class="chapter" data-level="15.4" data-path="examples.html"><a href="examples.html#structure-two-strain-sir"><i class="fa fa-check"></i><b>15.4</b> Structure: Two-Strain SIR</a></li>
<li class="chapter" data-level="15.5" data-path="examples.html"><a href="examples.html#erlang-seir"><i class="fa fa-check"></i><b>15.5</b> Erlang SEIR</a></li>
<li class="chapter" data-level="15.6" data-path="examples.html"><a href="examples.html#sirv"><i class="fa fa-check"></i><b>15.6</b> SIRV</a></li>
<li class="chapter" data-level="15.7" data-path="examples.html"><a href="examples.html#variolation-model"><i class="fa fa-check"></i><b>15.7</b> Variolation model</a></li>
<li class="chapter" data-level="15.8" data-path="examples.html"><a href="examples.html#seird"><i class="fa fa-check"></i><b>15.8</b> SEIRD</a></li>
<li class="chapter" data-level="15.9" data-path="examples.html"><a href="examples.html#covid-seir"><i class="fa fa-check"></i><b>15.9</b> Covid SEIR</a></li>
<li class="chapter" data-level="15.10" data-path="examples.html"><a href="examples.html#bc-covid-omicron"><i class="fa fa-check"></i><b>15.10</b> BC Covid Omicron</a></li>
<li class="chapter" data-level="15.11" data-path="examples.html"><a href="examples.html#classic-mcmasterpandemic"><i class="fa fa-check"></i><b>15.11</b> Classic McMasterPandemic</a></li>
<li class="chapter" data-level="15.12" data-path="examples.html"><a href="examples.html#granich-hiv-model"><i class="fa fa-check"></i><b>15.12</b> Granich HIV Model</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="troubleshooting.html"><a href="troubleshooting.html"><i class="fa fa-check"></i><b>16</b> Troubleshooting</a><ul>
<li class="chapter" data-level="16.1" data-path="troubleshooting.html"><a href="troubleshooting.html#nan-valued-objective-function"><i class="fa fa-check"></i><b>16.1</b> NaN-Valued Objective Function</a><ul>
<li class="chapter" data-level="16.1.1" data-path="troubleshooting.html"><a href="troubleshooting.html#simulated-time-series-close-to-zero"><i class="fa fa-check"></i><b>16.1.1</b> Simulated time-series close to zero</a></li>
<li class="chapter" data-level="16.1.2" data-path="troubleshooting.html"><a href="troubleshooting.html#negative-rate-matrix-elements"><i class="fa fa-check"></i><b>16.1.2</b> Negative rate matrix elements</a></li>
<li class="chapter" data-level="16.1.3" data-path="troubleshooting.html"><a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters"><i class="fa fa-check"></i><b>16.1.3</b> Optimizer tries very large dispersion parameters</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="troubleshooting.html"><a href="troubleshooting.html#non-positive-definite-covariance-matrix"><i class="fa fa-check"></i><b>16.2</b> Non-Positive Definite Covariance Matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Generalized McMasterPandemic</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="time-varying-parameters" class="section level1 hasAnchor">
<h1><span class="header-section-number">7</span> Time Varying Parameters<a href="time-varying-parameters.html#time-varying-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Any parameter in a <code>McMasterPandemic</code> model can be scheduled to vary in time.</p>
<p>In this example we create a time-variation schedule that causes the transmission, <code>beta</code>, drop to very low levels on May 15.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="time-varying-parameters.html#cb67-1"></a>random_timevar =<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb67-2"><a href="time-varying-parameters.html#cb67-2"></a>  <span class="dt">Date =</span> <span class="kw">ymd</span>(<span class="dv">20200515</span>),</span>
<span id="cb67-3"><a href="time-varying-parameters.html#cb67-3"></a>  <span class="dt">Symbol =</span> <span class="st">&#39;beta&#39;</span>,</span>
<span id="cb67-4"><a href="time-varying-parameters.html#cb67-4"></a>  <span class="dt">Value =</span> <span class="fl">0.01</span>,</span>
<span id="cb67-5"><a href="time-varying-parameters.html#cb67-5"></a>  <span class="dt">Type =</span> <span class="st">&#39;abs&#39;</span></span>
<span id="cb67-6"><a href="time-varying-parameters.html#cb67-6"></a>)</span>
<span id="cb67-7"><a href="time-varying-parameters.html#cb67-7"></a>random_timevar</span></code></pre></div>
<pre><code>##         Date Symbol Value Type
## 1 2020-05-15   beta  0.01  abs</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="time-varying-parameters.html#cb69-1"></a>sir_with_timevar =<span class="st"> </span>(sir</span>
<span id="cb69-2"><a href="time-varying-parameters.html#cb69-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_piece_wise</span>(random_timevar)</span>
<span id="cb69-3"><a href="time-varying-parameters.html#cb69-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_error_dist</span>(</span>
<span id="cb69-4"><a href="time-varying-parameters.html#cb69-4"></a>    S <span class="op">~</span><span class="st"> </span><span class="kw">poisson</span>(),</span>
<span id="cb69-5"><a href="time-varying-parameters.html#cb69-5"></a>    I <span class="op">~</span><span class="st"> </span><span class="kw">poisson</span>(),</span>
<span id="cb69-6"><a href="time-varying-parameters.html#cb69-6"></a>    R <span class="op">~</span><span class="st"> </span><span class="kw">poisson</span>()</span>
<span id="cb69-7"><a href="time-varying-parameters.html#cb69-7"></a>  )</span>
<span id="cb69-8"><a href="time-varying-parameters.html#cb69-8"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="time-varying-parameters.html#cb70-1"></a>timevar_sims =<span class="st"> </span>(sir_with_timevar</span>
<span id="cb70-2"><a href="time-varying-parameters.html#cb70-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">simulation_history</span>(<span class="dt">include_initial_date =</span> <span class="ot">FALSE</span>, <span class="dt">obs_error =</span> <span class="ot">TRUE</span>)</span>
<span id="cb70-3"><a href="time-varying-parameters.html#cb70-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="op">-</span>Date, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>)</span>
<span id="cb70-4"><a href="time-varying-parameters.html#cb70-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date =</span> Date)</span>
<span id="cb70-5"><a href="time-varying-parameters.html#cb70-5"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">round</span>(value))</span>
<span id="cb70-6"><a href="time-varying-parameters.html#cb70-6"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(var <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="st">&quot;R&quot;</span>))</span>
<span id="cb70-7"><a href="time-varying-parameters.html#cb70-7"></a>)</span>
<span id="cb70-8"><a href="time-varying-parameters.html#cb70-8"></a>(<span class="kw">ggplot</span>(timevar_sims)</span>
<span id="cb70-9"><a href="time-varying-parameters.html#cb70-9"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, value, <span class="dt">colour =</span> var))</span>
<span id="cb70-10"><a href="time-varying-parameters.html#cb70-10"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/simulate_with_timevar-1.png" width="672" /></p>
<p>Notice the abrupt break-point on May 15 that causes the numbers of infected individuals to decrease.</p>
<p>We can easily compare the parameters at the beginning of the simulation with parameters at the end of the simulation.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="time-varying-parameters.html#cb71-1"></a><span class="kw">pars_base_sim</span>(sir_with_timevar)</span></code></pre></div>
<pre><code>##  beta gamma     N 
## 1e-01 1e-02 1e+02</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="time-varying-parameters.html#cb73-1"></a><span class="kw">pars_base_final</span>(sir_with_timevar)</span></code></pre></div>
<pre><code>##  beta gamma     N 
## 1e-02 1e-02 1e+02</code></pre>
<p>See [The SIRV model] and <a href="examples.html#covid-seir">Covid SEIR</a> for other examples of the use of time-varying parameters in simulation models.</p>
<div class="infobox caution">
<p>There are a few places you can go from here:</p>
<ol style="list-style-type: decimal">
<li>Keep reading to learn about the general <a href="time-varying-parameters.html#model-of-piece-wise-time-variation">Model of Piece-Wise Time-Variation</a> that is used by McMasterPandemic</li>
<li>Learn about <a href="time-varying-parameters.html#calibrating-time-variation-schedules">Calibrating Time-Variation Schedules</a></li>
<li>Learn how to forecast with time-variation schedules in order to explore <a href="ensemble-forecasts.html#time-varying-ensemble-forecasts">what-if-scenarios</a></li>
<li>Learn how to <a href="troubleshooting.html#negative-rate-matrix-elements">specify time-variation multipliers on the logit-scale</a> for parameters that should be bound between zero and one</li>
<li>TODO: Complex Time-Variation Schedules</li>
<li>TODO: When log-linear models are developed there should be a pointer to their documentation here</li>
</ol>
</div>
<div id="model-of-piece-wise-time-variation" class="section level2 hasAnchor">
<h2><span class="header-section-number">7.1</span> Model of Piece-Wise Time-Variation<a href="time-varying-parameters.html#model-of-piece-wise-time-variation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A time-variation schedule is a data frame with one row for each date on which each parameter changes its value. This data frame has four columns that can be used to define the characteristics of each break-point.</p>
<ul>
<li><code>Date</code> – Date on which a particular parameter changes its value</li>
<li><code>Symbol</code> – String giving the symbol representing the changing parameter</li>
<li><code>Value</code> – The numeric value used to change the value of the parameter, the effect of which depends on the value of the <code>Type</code> column</li>
<li><code>Type</code> – One of the following strings:
<ul>
<li><code>"abs"</code> – The <code>Value</code> column is the new value for the parameter on <code>Date</code></li>
<li><code>"rel_orig"</code> – The <code>Value</code> column is multiplied by the original value of the changing parameter at the beginning of the simulation, to generate a new value for the parameter on <code>Date</code></li>
<li><code>"rel_prev"</code> – The <code>Value</code> column is multiplied by the previous value of the changing parameter, to generate a new value for the parameter on <code>Date</code></li>
<li><code>"rel_orig_logit"</code> – The <code>Value</code> column is added to the logit transform of the original value, and then the inverse logit transform is applied to this sum to generate a new value for the parameter on <code>Date</code></li>
<li><code>"rel_prev_logit"</code> – The <code>Value</code> column is added to the logit transform of the previous value of the changing parameter, and then the inverse logit transform is applied to this sum to generate a new value for the parameter on <code>Date</code></li>
</ul></li>
</ul>
<p>Let <span class="math inline">\(\theta_t\)</span> be the focal parameter at time <span class="math inline">\(t\)</span>, let <span class="math inline">\(\theta_0\)</span> be the original value of <span class="math inline">\(\theta\)</span> at the beginning of the simulation, let <span class="math inline">\(t = \tau\)</span> be a time at which <span class="math inline">\(\theta\)</span> changes value, and let <span class="math inline">\(\nu_\tau\)</span> be the number in the <code>Value</code> column associated with the breakpoint at <span class="math inline">\(\tau\)</span>. The following table describes the different types of time variation.</p>
<table>
<colgroup>
<col width="40%" />
<col width="59%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Time Variation Type</th>
<th align="left">Parameter Update Expression</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>abs</code></td>
<td align="left"><span class="math inline">\(\theta_\tau = \nu_\tau\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>rel_orig</code></td>
<td align="left"><span class="math inline">\(\theta_\tau = \theta_0 \nu_\tau\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>rel_prev</code></td>
<td align="left"><span class="math inline">\(\theta_\tau = \theta_{\tau-1} \nu_\tau\)</span></td>
</tr>
<tr class="even">
<td align="left"><code>rel_orig_logit</code></td>
<td align="left"><span class="math inline">\(\theta_\tau = \text{logit}^{-1}\left(\text{logit}(\theta_0) + \nu_\tau\right)\)</span></td>
</tr>
<tr class="odd">
<td align="left"><code>rel_prev_logit</code></td>
<td align="left"><span class="math inline">\(\theta_\tau = \text{logit}^{-1}\left(\text{logit}(\theta_{\tau-1}) + \nu_\tau\right)\)</span></td>
</tr>
</tbody>
</table>
<p>Once a time-variation data frame is produced it can get added to a model when it is created via the <code>params_timevar</code> argument of <code>flexmodel</code>, or by updating an existing <code>flexmodel</code> object using the <code>update_piece_wise</code> function.</p>
</div>
<div id="calibrating-time-variation-schedules" class="section level2 hasAnchor">
<h2><span class="header-section-number">7.2</span> Calibrating Time-Variation Schedules<a href="time-varying-parameters.html#calibrating-time-variation-schedules" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Entries in the <code>Value</code> column can be <code>NA</code>, indicating that these should be fitted using <a href="calibration.html#calibration">Calibration</a>. When flagging time-variation values for calibration in this way, one must also provide information on any parameter transformations and prior distributions. Do provide this information, we use a technique similar to the one described in the <a href="calibration.html#calibration">Calibration</a> chapter to specify transformations and prior distributions for parameters in the <code>params</code> element of <code>flexmodel</code> objects. In that chapter we used the <code>add_opt_params</code> function – here we use the <code>add_opt_tv_params</code> function (the <code>tv</code> stands for time-variation).</p>
<p>To illustrate calibration of time-variation values, we mark for calibration the break-point on May 15 in our example above.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="time-varying-parameters.html#cb75-1"></a>calibrate_timevar =<span class="st"> </span>(random_timevar</span>
<span id="cb75-2"><a href="time-varying-parameters.html#cb75-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Value =</span> <span class="ot">NA</span>)</span>
<span id="cb75-3"><a href="time-varying-parameters.html#cb75-3"></a>)</span></code></pre></div>
<p>Then we update our model with the <code>sir_with_timevar</code> simulations to fit to, and specify how to optimize the parameters.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="time-varying-parameters.html#cb76-1"></a>sir_to_cal_tv =<span class="st"> </span>(sir_with_timevar</span>
<span id="cb76-2"><a href="time-varying-parameters.html#cb76-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_observed</span>(timevar_sims)</span>
<span id="cb76-3"><a href="time-varying-parameters.html#cb76-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_piece_wise</span>(calibrate_timevar)</span>
<span id="cb76-4"><a href="time-varying-parameters.html#cb76-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_opt_params</span>(log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="op">-</span><span class="dv">2</span>))</span>
<span id="cb76-5"><a href="time-varying-parameters.html#cb76-5"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_opt_tv_params</span>(<span class="dt">tv_type =</span> <span class="st">&quot;abs&quot;</span></span>
<span id="cb76-6"><a href="time-varying-parameters.html#cb76-6"></a>    , log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="op">-</span><span class="dv">4</span>)</span>
<span id="cb76-7"><a href="time-varying-parameters.html#cb76-7"></a>  )</span>
<span id="cb76-8"><a href="time-varying-parameters.html#cb76-8"></a>)</span></code></pre></div>
<p>The key function here is <code>add_opt_tv_params</code>, which allows us to specify a flat prior on the log scale for fitting the time-variation values.</p>
<p>It turns out that in this case we need to make one technical adjustment – see <a href="troubleshooting.html#simulated-time-series-close-to-zero">Simulated time-series close to zero</a> for an explanation.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="time-varying-parameters.html#cb77-1"></a>sir_to_cal_tv<span class="op">$</span>do_sim_constraint =<span class="st"> </span><span class="ot">TRUE</span></span></code></pre></div>
<p>With this <code>sir_to_cal_tv</code> object we can now fit this model to the simulated data.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="time-varying-parameters.html#cb78-1"></a>sir_cal_tv =<span class="st"> </span><span class="kw">calibrate_flexmodel</span>(sir_to_cal_tv)</span></code></pre></div>
<p>The time-variation values before, during, and after optimization look as we would expect, given that we fitted to the same model that generated the data.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="time-varying-parameters.html#cb79-1"></a><span class="kw">c</span>(</span>
<span id="cb79-2"><a href="time-varying-parameters.html#cb79-2"></a>  <span class="dt">before =</span> <span class="kw">pars_time_series</span>(sir_with_timevar)<span class="op">$</span>Value,</span>
<span id="cb79-3"><a href="time-varying-parameters.html#cb79-3"></a>  <span class="dt">during =</span> <span class="kw">pars_time_series</span>(sir_to_cal_tv)   <span class="op">$</span>Value,</span>
<span id="cb79-4"><a href="time-varying-parameters.html#cb79-4"></a>  <span class="dt">after  =</span> <span class="kw">pars_time_series</span>(sir_cal_tv)      <span class="op">$</span>Value</span>
<span id="cb79-5"><a href="time-varying-parameters.html#cb79-5"></a>)</span></code></pre></div>
<pre><code>##      before      during       after 
## 0.010000000 1.000000000 0.009242963</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="time-varying-parameters.html#cb81-1"></a>(sir_cal_tv</span>
<span id="cb81-2"><a href="time-varying-parameters.html#cb81-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span>fitted</span>
<span id="cb81-3"><a href="time-varying-parameters.html#cb81-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">var =</span> <span class="kw">factor</span>(var, <span class="kw">topological_sort</span>(sir_cal_tv)))</span>
<span id="cb81-4"><a href="time-varying-parameters.html#cb81-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span>ggplot</span>
<span id="cb81-5"><a href="time-varying-parameters.html#cb81-5"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var)</span>
<span id="cb81-6"><a href="time-varying-parameters.html#cb81-6"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, value))</span>
<span id="cb81-7"><a href="time-varying-parameters.html#cb81-7"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, value_fitted), <span class="dt">colour =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb81-8"><a href="time-varying-parameters.html#cb81-8"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/fit_timevar_plot-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="convergence.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="other-variables.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/canmod/macpan-book/edit/main/06-time-varying-parameters.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
