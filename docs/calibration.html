<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Calibration | Generalized McMasterPandemic</title>
  <meta name="description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Calibration | Generalized McMasterPandemic" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="github-repo" content="canmod/macpan-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Calibration | Generalized McMasterPandemic" />
  
  <meta name="twitter:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  

<meta name="author" content="Steve Walker" />


<meta name="date" content="2022-06-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="simulation.html"/>
<link rel="next" href="convergence.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
<script src="libs/vis-9.1.0/vis-network.min.js"></script>
<script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">McMasterPandemic</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Fast and Flexible Modelling with McMasterPandemic</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#history-and-motivation"><i class="fa fa-check"></i><b>1.1</b> History and Motivation</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#covid-19-forecasts"><i class="fa fa-check"></i><b>1.1.1</b> COVID-19 Forecasts</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#calibration-to-data"><i class="fa fa-check"></i><b>1.1.2</b> Calibration to data</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#speed"><i class="fa fa-check"></i><b>1.1.3</b> Speed</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#model-extensibility"><i class="fa fa-check"></i><b>1.1.4</b> Model Extensibility</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dependencies"><i class="fa fa-check"></i><b>1.3</b> Dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#generalized-model-at-a-glance"><i class="fa fa-check"></i><b>1.4</b> Generalized Model at a Glance</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="model-initialization.html"><a href="model-initialization.html"><i class="fa fa-check"></i><b>2</b> Model Initialization</a><ul>
<li class="chapter" data-level="2.1" data-path="model-initialization.html"><a href="model-initialization.html#initial-parameter-vector"><i class="fa fa-check"></i><b>2.1</b> Initial Parameter Vector</a></li>
<li class="chapter" data-level="2.2" data-path="model-initialization.html"><a href="model-initialization.html#initial-state-vector"><i class="fa fa-check"></i><b>2.2</b> Initial State Vector</a></li>
<li class="chapter" data-level="2.3" data-path="model-initialization.html"><a href="model-initialization.html#start-and-end-date"><i class="fa fa-check"></i><b>2.3</b> Start and End Date</a></li>
<li class="chapter" data-level="2.4" data-path="model-initialization.html"><a href="model-initialization.html#next-steps"><i class="fa fa-check"></i><b>2.4</b> Next Steps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="flow-between-states.html"><a href="flow-between-states.html"><i class="fa fa-check"></i><b>3</b> Flow Between States</a><ul>
<li class="chapter" data-level="3.1" data-path="flow-between-states.html"><a href="flow-between-states.html#state-flows"><i class="fa fa-check"></i><b>3.1</b> State Flows</a></li>
<li class="chapter" data-level="3.2" data-path="flow-between-states.html"><a href="flow-between-states.html#flow-matrix"><i class="fa fa-check"></i><b>3.2</b> Flow Matrix</a></li>
<li class="chapter" data-level="3.3" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix"><i class="fa fa-check"></i><b>3.3</b> Rate Matrix</a></li>
<li class="chapter" data-level="3.4" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters"><i class="fa fa-check"></i><b>3.4</b> Rate Matrix Dependence on State Variables and Parameters</a></li>
<li class="chapter" data-level="3.5" data-path="flow-between-states.html"><a href="flow-between-states.html#connections-with-classic-mcmasterpandemic"><i class="fa fa-check"></i><b>3.5</b> Connections with Classic McMasterPandemic</a></li>
<li class="chapter" data-level="3.6" data-path="flow-between-states.html"><a href="flow-between-states.html#topological-sort"><i class="fa fa-check"></i><b>3.6</b> Topological Sort</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>4</b> Simulation</a><ul>
<li class="chapter" data-level="4.1" data-path="simulation.html"><a href="simulation.html#observation-error"><i class="fa fa-check"></i><b>4.1</b> Observation Error</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>5</b> Calibration</a><ul>
<li class="chapter" data-level="5.1" data-path="calibration.html"><a href="calibration.html#calibrating-with-observation-error"><i class="fa fa-check"></i><b>5.1</b> Calibrating with Observation Error</a></li>
<li class="chapter" data-level="5.2" data-path="calibration.html"><a href="calibration.html#loss-function-theory"><i class="fa fa-check"></i><b>5.2</b> Loss Function Theory</a><ul>
<li class="chapter" data-level="5.2.1" data-path="calibration.html"><a href="calibration.html#negative-binomial"><i class="fa fa-check"></i><b>5.2.1</b> Negative Binomial</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="convergence.html"><a href="convergence.html"><i class="fa fa-check"></i><b>6</b> Convergence</a></li>
<li class="chapter" data-level="7" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html"><i class="fa fa-check"></i><b>7</b> Time Varying Parameters</a><ul>
<li class="chapter" data-level="7.1" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#example-of-time-variation"><i class="fa fa-check"></i><b>7.1</b> Example of Time-Variation</a></li>
<li class="chapter" data-level="7.2" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#calibrating-time-variation-schedules"><i class="fa fa-check"></i><b>7.2</b> Calibrating Time-Variation Schedules</a></li>
<li class="chapter" data-level="7.3" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#scenario-exploration-forecasting-with-time-variation-schedules"><i class="fa fa-check"></i><b>7.3</b> Scenario Exploration – Forecasting with Time-Variation Schedules</a></li>
<li class="chapter" data-level="7.4" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#complex-time-variation-schedules"><i class="fa fa-check"></i><b>7.4</b> Complex Time-Variation Schedules</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-variables.html"><a href="other-variables.html"><i class="fa fa-check"></i><b>8</b> Other Variables</a><ul>
<li class="chapter" data-level="8.1" data-path="other-variables.html"><a href="other-variables.html#intermediate-results"><i class="fa fa-check"></i><b>8.1</b> Intermediate Results</a><ul>
<li class="chapter" data-level="8.1.1" data-path="other-variables.html"><a href="other-variables.html#sums-of-state-variables-and-parameters"><i class="fa fa-check"></i><b>8.1.1</b> Sums of State Variables and Parameters</a></li>
<li class="chapter" data-level="8.1.2" data-path="other-variables.html"><a href="other-variables.html#factrs"><i class="fa fa-check"></i><b>8.1.2</b> Factrs</a></li>
<li class="chapter" data-level="8.1.3" data-path="other-variables.html"><a href="other-variables.html#power-laws"><i class="fa fa-check"></i><b>8.1.3</b> Power Laws</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="other-variables.html"><a href="other-variables.html#additional-variables-in-the-simulation-history"><i class="fa fa-check"></i><b>8.2</b> Additional Variables in the Simulation History</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-variables.html"><a href="other-variables.html#simulation-history-expressions"><i class="fa fa-check"></i><b>8.2.1</b> Simulation History Expressions</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-variables.html"><a href="other-variables.html#lagged-differencing"><i class="fa fa-check"></i><b>8.2.2</b> Lagged Differencing</a></li>
<li class="chapter" data-level="8.2.3" data-path="other-variables.html"><a href="other-variables.html#convolutions"><i class="fa fa-check"></i><b>8.2.3</b> Convolutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html"><i class="fa fa-check"></i><b>9</b> Ensemble Forecasts</a><ul>
<li class="chapter" data-level="9.1" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html#time-varying-ensemble-forecasts"><i class="fa fa-check"></i><b>9.1</b> Time-Varying Ensemble Forecasts</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>10</b> Vectors</a></li>
<li class="chapter" data-level="11" data-path="hazard-smoothing.html"><a href="hazard-smoothing.html"><i class="fa fa-check"></i><b>11</b> Hazard Smoothing</a></li>
<li class="chapter" data-level="12" data-path="state-initialization.html"><a href="state-initialization.html"><i class="fa fa-check"></i><b>12</b> State Initialization</a></li>
<li class="chapter" data-level="13" data-path="outflows.html"><a href="outflows.html"><i class="fa fa-check"></i><b>13</b> Outflows</a><ul>
<li class="chapter" data-level="13.1" data-path="outflows.html"><a href="outflows.html#accumulators"><i class="fa fa-check"></i><b>13.1</b> Accumulators</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="tmb-engine.html"><a href="tmb-engine.html"><i class="fa fa-check"></i><b>14</b> TMB Engine</a></li>
<li class="chapter" data-level="15" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>15</b> Examples</a><ul>
<li class="chapter" data-level="15.1" data-path="examples.html"><a href="examples.html#hello-world-simulating-an-sir-model"><i class="fa fa-check"></i><b>15.1</b> Hello World: Simulating an SIR Model</a></li>
<li class="chapter" data-level="15.2" data-path="examples.html"><a href="examples.html#si"><i class="fa fa-check"></i><b>15.2</b> SI</a></li>
<li class="chapter" data-level="15.3" data-path="examples.html"><a href="examples.html#seir"><i class="fa fa-check"></i><b>15.3</b> SEIR</a></li>
<li class="chapter" data-level="15.4" data-path="examples.html"><a href="examples.html#structure-two-strain-sir"><i class="fa fa-check"></i><b>15.4</b> Structure: Two-Strain SIR</a></li>
<li class="chapter" data-level="15.5" data-path="examples.html"><a href="examples.html#erlang-seir"><i class="fa fa-check"></i><b>15.5</b> Erlang SEIR</a></li>
<li class="chapter" data-level="15.6" data-path="examples.html"><a href="examples.html#sirv"><i class="fa fa-check"></i><b>15.6</b> SIRV</a></li>
<li class="chapter" data-level="15.7" data-path="examples.html"><a href="examples.html#variolation-model"><i class="fa fa-check"></i><b>15.7</b> Variolation model</a></li>
<li class="chapter" data-level="15.8" data-path="examples.html"><a href="examples.html#seird"><i class="fa fa-check"></i><b>15.8</b> SEIRD</a></li>
<li class="chapter" data-level="15.9" data-path="examples.html"><a href="examples.html#covid-seir"><i class="fa fa-check"></i><b>15.9</b> Covid SEIR</a></li>
<li class="chapter" data-level="15.10" data-path="examples.html"><a href="examples.html#bc-covid-omicron"><i class="fa fa-check"></i><b>15.10</b> BC Covid Omicron</a></li>
<li class="chapter" data-level="15.11" data-path="examples.html"><a href="examples.html#classic-mcmasterpandemic"><i class="fa fa-check"></i><b>15.11</b> Classic McMasterPandemic</a></li>
<li class="chapter" data-level="15.12" data-path="examples.html"><a href="examples.html#granich-hiv-model"><i class="fa fa-check"></i><b>15.12</b> Granich HIV Model</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="troubleshooting.html"><a href="troubleshooting.html"><i class="fa fa-check"></i><b>16</b> Troubleshooting</a><ul>
<li class="chapter" data-level="16.1" data-path="troubleshooting.html"><a href="troubleshooting.html#nan-valued-objective-function"><i class="fa fa-check"></i><b>16.1</b> NaN-Valued Objective Function</a><ul>
<li class="chapter" data-level="16.1.1" data-path="troubleshooting.html"><a href="troubleshooting.html#simulated-time-series-close-to-zero"><i class="fa fa-check"></i><b>16.1.1</b> Simulated time-series close to zero</a></li>
<li class="chapter" data-level="16.1.2" data-path="troubleshooting.html"><a href="troubleshooting.html#negative-rate-matrix-elements"><i class="fa fa-check"></i><b>16.1.2</b> Negative rate matrix elements</a></li>
<li class="chapter" data-level="16.1.3" data-path="troubleshooting.html"><a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters"><i class="fa fa-check"></i><b>16.1.3</b> Optimizer tries very large dispersion parameters</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="troubleshooting.html"><a href="troubleshooting.html#non-positive-definite-covariance-matrix"><i class="fa fa-check"></i><b>16.2</b> Non-Positive Definite Covariance Matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Generalized McMasterPandemic</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calibration" class="section level1 hasAnchor">
<h1><span class="header-section-number">5</span> Calibration<a href="calibration.html#calibration" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Sometimes it is possible to obtain observed time-series data from an epidemic that one is modelling. It is natural to want to use such data to refine parameter values. This process of refinement is called calibration.</p>
<p>To illustrate McMasterPandemic calibration functionality, we are going to calibrate to a synthetic dataset generated by the model we are calibrating. In the last chapter we showed how to simulate from a simple SIR model. Here we simulate from this model and then manipulate the resulting data into a form that could be used for calibration. Although this functionality can be used to fit any number of model parameters to any number of observed time-series, here we generate a single time-series of the numbers of infected individuals.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="calibration.html#cb23-1"></a>synthetic_data =<span class="st"> </span>(sir</span>
<span id="cb23-2"><a href="calibration.html#cb23-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">simulation_history</span>(<span class="dt">include_initial_date =</span> <span class="ot">FALSE</span>)</span>
<span id="cb23-3"><a href="calibration.html#cb23-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Date, I)</span>
<span id="cb23-4"><a href="calibration.html#cb23-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Date, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb23-5"><a href="calibration.html#cb23-5"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date =</span> Date)</span>
<span id="cb23-6"><a href="calibration.html#cb23-6"></a>)</span></code></pre></div>
<p>When fitting data to a model, a specific format must be used. In particular there must be exactly the following three columns.</p>
<ul>
<li><code>date</code> – date associated with each observation</li>
<li><code>var</code> – name of the state variable to compare</li>
<li><code>value</code> – observed value to compare with the simulated state variable</li>
</ul>
<p>In this particular case there is only a single state variable used, but this need not be the case.</p>
<p>We next update the model object so that it contains two new ingredients: (1) the observed time-series data and (2) information on what parameters to fit and how to fit them.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="calibration.html#cb24-1"></a>sir_to_calibrate =<span class="st"> </span>(sir</span>
<span id="cb24-2"><a href="calibration.html#cb24-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_observed</span>(synthetic_data)</span>
<span id="cb24-3"><a href="calibration.html#cb24-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_opt_params</span>(</span>
<span id="cb24-4"><a href="calibration.html#cb24-4"></a>    log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_flat</span>(<span class="dv">0</span>),</span>
<span id="cb24-5"><a href="calibration.html#cb24-5"></a>    log_nb_disp_I <span class="op">~</span><span class="st"> </span><span class="kw">log_normal</span>(<span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb24-6"><a href="calibration.html#cb24-6"></a>  )</span>
<span id="cb24-7"><a href="calibration.html#cb24-7"></a>)</span></code></pre></div>
<p>The observed time-series data are simply added via the <code>update_observed</code> function. The information of what parameters to fit gets passed to <code>update_opt_params</code>. This information is provided using two-sided formulas for each parameter to be optimized. The information on what parameter to optimize appears on the left-hand-side of the formula (i.e. to the left of the tilde). Here we optimize the transmission rate parameter, <code>beta</code>, because the numbers of infected individuals in our time-series will be most informative about this parameter. The prefix <code>log_</code> is used to indicate that the parameter should get passed to the objective function on the log scale. This transformation is useful because it keeps the transmission rate positive. If no transformation is desired, then simply <code>beta</code> should appear on the left-hand-side. The following additional transformations are available: <code>logit_</code>, <code>log10</code>, <code>cloglog_</code>, <code>inverse_</code>.</p>
<p>The information on what prior distribution (or regularization function) to use, as well as initial values for the optimizer, are provided on the right-hand-side of the formula. Currently, the transformation (i.e. <code>log_</code> in this case) must match the left-hand-side, although we plan to remove this restriction so that the scale on which the prior density is evaluated can be different from the scale on which the parameter is passed to the objective function. There are only two prior distributions available currently: <code>flat</code> and <code>normal</code>. The <code>flat</code> prior is an improper flat distribution, providing no regularization. The only hyperparameter to the <code>flat</code> prior is the initial value for the optimizer on the transformed scale. The <code>normal</code> prior is the normal distribution with two hyperparameters, mean and standard deviation. The mean is also taken as the starting value.</p>
<p>Note that there is another parameter that we need to describe that we did not include in our original definition of the model: <code>nb_disp_I</code>. This is the dispersion parameter of the negative binomial distribution used to model errors in the fit of the data to the simulated trajectories. We have used a <code>log_normal</code> prior here instead of a <code>log_flat</code> prior, because negative binomial dispersion parameters have a tendency to get very large in synthetic data cases like this where there is very little error – large dispersion parameters indicate consistency with Poisson error. This negative binomial parameter has been added automatically to the <code>params</code> element of the model when the observed data are added.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="calibration.html#cb25-1"></a>sir_to_calibrate<span class="op">$</span>params</span></code></pre></div>
<pre><code>##      beta     gamma         N nb_disp_I 
##     1e-01     1e-02     1e+02     1e+00</code></pre>
<p>But note how the parameters in the original model did not contain this parameter.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="calibration.html#cb27-1"></a>sir<span class="op">$</span>params</span></code></pre></div>
<pre><code>##  beta gamma     N 
## 1e-01 1e-02 1e+02</code></pre>
<p>The <code>sir_to_calibrate</code> object can be calibrated using one of the optimizers in R that have been wrapped for use with <code>flexmodel</code>s. There are currently two options: <code>nlminb_flexmodel</code> and <code>optim_flexmodel</code>. The difference between the two is that the former uses second-derivative information whereas the latter does not; they both use first-derivative information.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="calibration.html#cb29-1"></a>sir_calibrated =<span class="st"> </span><span class="kw">calibrate_flexmodel</span>(sir_to_calibrate)</span></code></pre></div>
<p>The result of these optimization functions is another model object containing additional information.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="calibration.html#cb30-1"></a><span class="kw">convergence_info</span>(sir_calibrated)</span></code></pre></div>
<pre><code>## $par
##      log_beta log_nb_disp_I 
##     -2.302585      9.365837 
## 
## $value
## [1] 677.25
## 
## $counts
## function gradient 
##       47       18 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##               [,1]          [,2]
## [1,]  9.040137e+03 -8.911629e-06
## [2,] -2.095180e-05  4.134060e-01
## 
## $maxgrad
## [1] 0.002784678
## 
## $eratio
## [1] 4.573006e-05</code></pre>
<p>This element is the object returned by the wrapped optimizer (<code>nlminb</code> in this case) – it can provide useful information about how well the optimization worked. In this case we see convergence, but this need not be true. Refer to documentation for <code>nlminb</code> and <code>optim</code> for help on interpreting these outputs.</p>
<p>We can now look at the parameter vector, which has been updated to reflect the calibration.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="calibration.html#cb32-1"></a>sir_calibrated<span class="op">$</span>params</span></code></pre></div>
<pre><code>##         beta        gamma            N    nb_disp_I 
## 9.999997e-02 1.000000e-02 1.000000e+02 1.168238e+04 
## attr(,&quot;tv_param_indices&quot;)
## named integer(0)</code></pre>
<p>Fitted <code>flexmodel</code> objects have a <code>fitted</code> method that can be used to compare the fits with the observed values.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="calibration.html#cb34-1"></a>(sir_calibrated</span>
<span id="cb34-2"><a href="calibration.html#cb34-2"></a> <span class="op">%&gt;%</span><span class="st"> </span>fitted</span>
<span id="cb34-3"><a href="calibration.html#cb34-3"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>()</span>
<span id="cb34-4"><a href="calibration.html#cb34-4"></a> <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date, value))</span>
<span id="cb34-5"><a href="calibration.html#cb34-5"></a> <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, value_fitted), <span class="dt">colour =</span> <span class="st">&#39;red&#39;</span>)</span>
<span id="cb34-6"><a href="calibration.html#cb34-6"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/calibrated_fits-1.png" width="672" /></p>
<p>As expected, the fit is exact because the model that was fitted was also used to simulate the data. But this perfect is not very realistic. The next section, <a href="calibration.html#calibrating-with-observation-error">Calibrating with Observation Error</a>, illustrates calibration to noisy data.</p>
<div id="calibrating-with-observation-error" class="section level2 hasAnchor">
<h2><span class="header-section-number">5.1</span> Calibrating with Observation Error<a href="calibration.html#calibrating-with-observation-error" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To illustrate fitting to data with observation error we simulate some noisy observations of numbers of individuals in the <code>I</code> compartment, using the simulation model we made in the <a href="simulation.html#observation-error">Observation Error</a> section.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="calibration.html#cb35-1"></a><span class="kw">set.seed</span>(1L)</span>
<span id="cb35-2"><a href="calibration.html#cb35-2"></a>noisy_data =<span class="st"> </span>(sir_with_obs_err</span>
<span id="cb35-3"><a href="calibration.html#cb35-3"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">simulation_history</span>(<span class="dt">include_initial_date =</span> <span class="ot">FALSE</span>, <span class="dt">obs_error =</span> <span class="ot">TRUE</span>)</span>
<span id="cb35-4"><a href="calibration.html#cb35-4"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Date, I)</span>
<span id="cb35-5"><a href="calibration.html#cb35-5"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Date, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>)</span>
<span id="cb35-6"><a href="calibration.html#cb35-6"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date =</span> Date)</span>
<span id="cb35-7"><a href="calibration.html#cb35-7"></a>)</span>
<span id="cb35-8"><a href="calibration.html#cb35-8"></a><span class="kw">ggplot</span>(noisy_data) <span class="op">+</span><span class="st"> </span></span>
<span id="cb35-9"><a href="calibration.html#cb35-9"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date, value))</span></code></pre></div>
<p><img src="_main_files/figure-html/simulate_noisy_data-1.png" width="672" /></p>
<p>We can fit these data to a model following the approaches in the <a href="calibration.html#calibration">Calibration</a> section.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="calibration.html#cb36-1"></a>sir_obs_err_to_calibrate =<span class="st"> </span>(sir_with_obs_err</span>
<span id="cb36-2"><a href="calibration.html#cb36-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_observed</span>(</span>
<span id="cb36-3"><a href="calibration.html#cb36-3"></a>    noisy_data, </span>
<span id="cb36-4"><a href="calibration.html#cb36-4"></a>    <span class="dt">loss_params =</span> <span class="kw">loss_params</span>(sir_with_obs_err)</span>
<span id="cb36-5"><a href="calibration.html#cb36-5"></a>  )</span>
<span id="cb36-6"><a href="calibration.html#cb36-6"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_opt_params</span>(log_beta <span class="op">~</span><span class="st"> </span><span class="kw">log_normal</span>(<span class="op">-</span><span class="dv">1</span>, <span class="fl">0.5</span>)</span>
<span id="cb36-7"><a href="calibration.html#cb36-7"></a>    ,log_nb_disp_I <span class="op">~</span><span class="st"> </span><span class="kw">log_normal</span>(<span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb36-8"><a href="calibration.html#cb36-8"></a>  )</span>
<span id="cb36-9"><a href="calibration.html#cb36-9"></a>)</span></code></pre></div>
<p>This process starts by updating the simulation model with observed data and specifying what parameters to optimize.</p>
<p>We may pass this model to the optimizer, and indeed do achieve convergence.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="calibration.html#cb37-1"></a>sir_obs_err_calibrated =<span class="st"> </span><span class="kw">calibrate_flexmodel</span>(sir_obs_err_to_calibrate)</span>
<span id="cb37-2"><a href="calibration.html#cb37-2"></a><span class="kw">print</span>(<span class="kw">class</span>(sir_obs_err_calibrated))</span></code></pre></div>
<pre><code>## [1] &quot;flexmodel_bbmle&quot;      &quot;flexmodel_calibrated&quot; &quot;flexmodel&quot;</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="calibration.html#cb39-1"></a><span class="kw">convergence_info</span>(sir_obs_err_calibrated)</span></code></pre></div>
<pre><code>## $par
##      log_beta log_nb_disp_I 
##     -2.300352      9.991748 
## 
## $value
## [1] 801.6395
## 
## $counts
## function gradient 
##       41       10 
## 
## $convergence
## [1] 0
## 
## $message
## NULL
## 
## $hessian
##              [,1]        [,2]
## [1,] 8.874538e+03 0.001175772
## [2,] 1.166795e-03 0.992192386
## 
## $maxgrad
## [1] 3.803997e-06
## 
## $eratio
## [1] 0.0001118022</code></pre>
<p>Not only do we achieve convergence but we also achieve a good fit, which is not surprising given that we are fitting the same model that was used to simulate the data.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="calibration.html#cb41-1"></a>(<span class="kw">fitted</span>(sir_obs_err_calibrated)</span>
<span id="cb41-2"><a href="calibration.html#cb41-2"></a>  <span class="op">%&gt;%</span><span class="st"> </span>ggplot</span>
<span id="cb41-3"><a href="calibration.html#cb41-3"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, value_fitted))</span>
<span id="cb41-4"><a href="calibration.html#cb41-4"></a>  <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(date, value))</span>
<span id="cb41-5"><a href="calibration.html#cb41-5"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/fit_plot_to_obs_err-1.png" width="672" /></p>
</div>
<div id="loss-function-theory" class="section level2 hasAnchor">
<h2><span class="header-section-number">5.2</span> Loss Function Theory<a href="calibration.html#loss-function-theory" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let <span class="math inline">\(l_{\psi_i}\left(x_i(\theta); y_i\right)\)</span> be a loss function where <span class="math inline">\(x_i(\theta)\)</span> is a simulated element of the history matrix, <span class="math inline">\(y_i\)</span> is an associated observed data point, and <span class="math inline">\(\psi_i\)</span> is a vector of loss function parameters. Note that we write the simulation values as functions of <span class="math inline">\(\theta\)</span> to indicate their dependence on parameters. Every element <span class="math inline">\(i\)</span> that belongs to the same column of the history matrix has the same value for <span class="math inline">\(\psi_i\)</span>, but to simplify notation <span class="math inline">\(\psi\)</span> is sub-scripted by <span class="math inline">\(i\)</span>. Let <span class="math inline">\(r_{\phi_j}(\theta_j)\)</span> be an optional regularization function for each parameter <span class="math inline">\(\theta_j\)</span> being optimized, where <span class="math inline">\(\phi_j\)</span> is a vector of regularization function parameters associated with parameter <span class="math inline">\(j\)</span>. The objective function is then given by the following.</p>
<p><span class="math display">\[
L_{\psi, \phi}(\theta; y) = \sum_i l_{\psi_i}\left(x_i(\theta); y_i\right) + \sum_j r_{\phi_j}(\theta_j)
\]</span>
Currently the only objective function that is offered is the negative log negative binomial density, but the infrastructure we build assumes that other loss functions will be allowed in the future. Similarly the only regularizing function that is available is the negative log normal density.</p>
<p>Each parameter, <span class="math inline">\(\theta_j\)</span>, can be optionally passed into the objective function on a <a href="https://canmod.net/misc/flex_specs#available-parameter-transformations">transformed scale</a>. These transformations allow users to enforce limits on the domain of the parameter space (e.g. a logit transformation will keep parameter values between 0 and 1). The regularization functions are applied on the transformed scale, but the elements of the rate matrix (and therefore the simulations, <span class="math inline">\(x\)</span>) are computed using the parameters on their original scale. Therefore, we have the following ordering of operations.</p>
<ol style="list-style-type: decimal">
<li>Parameter, <span class="math inline">\(\theta_j\)</span>, is passed in to the objective function on the transformed scale, <span class="math inline">\(f(\theta_j)\)</span></li>
<li>The regularization function, <span class="math inline">\(r_{\phi_j}(\theta_j)\)</span>, is computed and saved</li>
<li>The inverse transformation is applied to the parameter, <span class="math inline">\(\theta_j\)</span>, and the result is used to overwrite the previous value in the <code>c++</code> <code>params</code> vector</li>
<li>The simulations are made</li>
<li>The objective function, <span class="math inline">\(L\)</span>, is computed, and this computation includes adding the saved values of the regularization functions</li>
<li>The objective function, <span class="math inline">\(L\)</span>, is returned by the <code>c++</code> function <code>objective_function</code></li>
</ol>
<div id="negative-binomial" class="section level3 hasAnchor">
<h3><span class="header-section-number">5.2.1</span> Negative Binomial<a href="calibration.html#negative-binomial" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span class="math display">\[
\frac{\Gamma(x+k)}{\Gamma(k) x!} \left(\frac{k}{k + \mu}\right)^k \left(\frac{\mu}{k + \mu}\right)^x
\]</span>
<span class="math display">\[
\log\Gamma(x+k) - \log\Gamma(k) - \log(x!) + k \log\left(\frac{k}{k + \mu}\right) + x\log\left(\frac{\mu}{k + \mu}\right)
\]</span></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="simulation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="convergence.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/canmod/macpan-book/edit/main/04-calibration.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
