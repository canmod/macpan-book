<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Flow Between States | Generalized McMasterPandemic</title>
  <meta name="description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Flow Between States | Generalized McMasterPandemic" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="github-repo" content="canmod/macpan-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Flow Between States | Generalized McMasterPandemic" />
  
  <meta name="twitter:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  

<meta name="author" content="Steve Walker" />


<meta name="date" content="2022-05-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="simple-model-initialization.html"/>
<link rel="next" href="simulation.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">McMasterPandemic</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Fast and Flexible Modelling with McMasterPandemic</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#history-and-motivation"><i class="fa fa-check"></i><b>1.1</b> History and Motivation</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#covid-19-forecasts"><i class="fa fa-check"></i><b>1.1.1</b> COVID-19 Forecasts</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#calibration-to-data"><i class="fa fa-check"></i><b>1.1.2</b> Calibration to data</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#speed"><i class="fa fa-check"></i><b>1.1.3</b> Speed</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#model-extensibility"><i class="fa fa-check"></i><b>1.1.4</b> Model Extensibility</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dependencies"><i class="fa fa-check"></i><b>1.3</b> Dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#generalized-model-at-a-glance"><i class="fa fa-check"></i><b>1.4</b> Generalized Model at a Glance</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="simple-model-initialization.html"><a href="simple-model-initialization.html"><i class="fa fa-check"></i><b>2</b> Simple Model Initialization</a><ul>
<li class="chapter" data-level="2.1" data-path="simple-model-initialization.html"><a href="simple-model-initialization.html#initial-parameter-vector"><i class="fa fa-check"></i><b>2.1</b> Initial Parameter Vector</a></li>
<li class="chapter" data-level="2.2" data-path="simple-model-initialization.html"><a href="simple-model-initialization.html#initial-state-vector"><i class="fa fa-check"></i><b>2.2</b> Initial State Vector</a></li>
<li class="chapter" data-level="2.3" data-path="simple-model-initialization.html"><a href="simple-model-initialization.html#start-and-end-date"><i class="fa fa-check"></i><b>2.3</b> Start and End Date</a></li>
<li class="chapter" data-level="2.4" data-path="simple-model-initialization.html"><a href="simple-model-initialization.html#next-steps"><i class="fa fa-check"></i><b>2.4</b> Next Steps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="flow-between-states.html"><a href="flow-between-states.html"><i class="fa fa-check"></i><b>3</b> Flow Between States</a><ul>
<li class="chapter" data-level="3.1" data-path="flow-between-states.html"><a href="flow-between-states.html#state-flows"><i class="fa fa-check"></i><b>3.1</b> State Flows</a></li>
<li class="chapter" data-level="3.2" data-path="flow-between-states.html"><a href="flow-between-states.html#flow-matrix"><i class="fa fa-check"></i><b>3.2</b> Flow Matrix</a></li>
<li class="chapter" data-level="3.3" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix"><i class="fa fa-check"></i><b>3.3</b> Rate Matrix</a></li>
<li class="chapter" data-level="3.4" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters"><i class="fa fa-check"></i><b>3.4</b> Rate Matrix Dependence on State Variables and Parameters</a></li>
<li class="chapter" data-level="3.5" data-path="flow-between-states.html"><a href="flow-between-states.html#connections-with-classic-mcmasterpandemic"><i class="fa fa-check"></i><b>3.5</b> Connections with Classic McMasterPandemic</a></li>
<li class="chapter" data-level="3.6" data-path="flow-between-states.html"><a href="flow-between-states.html#topological-sort"><i class="fa fa-check"></i><b>3.6</b> Topological Sort</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>4</b> Simulation</a><ul>
<li class="chapter" data-level="4.1" data-path="simulation.html"><a href="simulation.html#observation-error"><i class="fa fa-check"></i><b>4.1</b> Observation Error</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>5</b> Calibration</a><ul>
<li class="chapter" data-level="5.1" data-path="calibration.html"><a href="calibration.html#calibrating-with-observation-error"><i class="fa fa-check"></i><b>5.1</b> Calibrating with Observation Error</a></li>
<li class="chapter" data-level="5.2" data-path="calibration.html"><a href="calibration.html#loss-function-theory"><i class="fa fa-check"></i><b>5.2</b> Loss Function Theory</a><ul>
<li class="chapter" data-level="5.2.1" data-path="calibration.html"><a href="calibration.html#negative-binomial"><i class="fa fa-check"></i><b>5.2.1</b> Negative Binomial</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="convergence.html"><a href="convergence.html"><i class="fa fa-check"></i><b>6</b> Convergence</a></li>
<li class="chapter" data-level="7" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html"><i class="fa fa-check"></i><b>7</b> Time Varying Parameters</a><ul>
<li class="chapter" data-level="7.1" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#example-of-time-variation"><i class="fa fa-check"></i><b>7.1</b> Example of Time-Variation</a></li>
<li class="chapter" data-level="7.2" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#calibrating-time-variation-schedules"><i class="fa fa-check"></i><b>7.2</b> Calibrating Time-Variation Schedules</a></li>
<li class="chapter" data-level="7.3" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#scenario-exploration-forecasting-with-time-variation-schedules"><i class="fa fa-check"></i><b>7.3</b> Scenario Exploration – Forecasting with Time-Variation Schedules</a></li>
<li class="chapter" data-level="7.4" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#complex-time-variation-schedules"><i class="fa fa-check"></i><b>7.4</b> Complex Time-Variation Schedules</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-variables.html"><a href="other-variables.html"><i class="fa fa-check"></i><b>8</b> Other Variables</a><ul>
<li class="chapter" data-level="8.1" data-path="other-variables.html"><a href="other-variables.html#intermediate-results"><i class="fa fa-check"></i><b>8.1</b> Intermediate Results</a><ul>
<li class="chapter" data-level="8.1.1" data-path="other-variables.html"><a href="other-variables.html#sums-of-state-variables-and-parameters"><i class="fa fa-check"></i><b>8.1.1</b> Sums of State Variables and Parameters</a></li>
<li class="chapter" data-level="8.1.2" data-path="other-variables.html"><a href="other-variables.html#factrs"><i class="fa fa-check"></i><b>8.1.2</b> Factrs</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="other-variables.html"><a href="other-variables.html#additional-variables-in-the-simulation-history"><i class="fa fa-check"></i><b>8.2</b> Additional Variables in the Simulation History</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-variables.html"><a href="other-variables.html#simulation-history-expressions"><i class="fa fa-check"></i><b>8.2.1</b> Simulation History Expressions</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-variables.html"><a href="other-variables.html#lagged-differencing"><i class="fa fa-check"></i><b>8.2.2</b> Lagged Differencing</a></li>
<li class="chapter" data-level="8.2.3" data-path="other-variables.html"><a href="other-variables.html#convolutions"><i class="fa fa-check"></i><b>8.2.3</b> Convolutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html"><i class="fa fa-check"></i><b>9</b> Ensemble Forecasts</a><ul>
<li class="chapter" data-level="9.1" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html#time-varying-ensemble-forecasts"><i class="fa fa-check"></i><b>9.1</b> Time-Varying Ensemble Forecasts</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>10</b> Vectors</a></li>
<li class="chapter" data-level="11" data-path="hazard-smoothing.html"><a href="hazard-smoothing.html"><i class="fa fa-check"></i><b>11</b> Hazard Smoothing</a></li>
<li class="chapter" data-level="12" data-path="state-initialization.html"><a href="state-initialization.html"><i class="fa fa-check"></i><b>12</b> State Initialization</a></li>
<li class="chapter" data-level="13" data-path="outflows.html"><a href="outflows.html"><i class="fa fa-check"></i><b>13</b> Outflows</a><ul>
<li class="chapter" data-level="13.1" data-path="outflows.html"><a href="outflows.html#accumulators"><i class="fa fa-check"></i><b>13.1</b> Accumulators</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>14</b> Examples</a><ul>
<li class="chapter" data-level="14.1" data-path="examples.html"><a href="examples.html#hello-world-simulating-an-sir-model"><i class="fa fa-check"></i><b>14.1</b> Hello World: Simulating an SIR Model</a></li>
<li class="chapter" data-level="14.2" data-path="examples.html"><a href="examples.html#si"><i class="fa fa-check"></i><b>14.2</b> SI</a></li>
<li class="chapter" data-level="14.3" data-path="examples.html"><a href="examples.html#seir"><i class="fa fa-check"></i><b>14.3</b> SEIR</a></li>
<li class="chapter" data-level="14.4" data-path="examples.html"><a href="examples.html#structure-two-strain-sir"><i class="fa fa-check"></i><b>14.4</b> Structure: Two-Strain SIR</a></li>
<li class="chapter" data-level="14.5" data-path="examples.html"><a href="examples.html#erlang-seir"><i class="fa fa-check"></i><b>14.5</b> Erlang SEIR</a></li>
<li class="chapter" data-level="14.6" data-path="examples.html"><a href="examples.html#sirv"><i class="fa fa-check"></i><b>14.6</b> SIRV</a></li>
<li class="chapter" data-level="14.7" data-path="examples.html"><a href="examples.html#variolation-model"><i class="fa fa-check"></i><b>14.7</b> Variolation model</a></li>
<li class="chapter" data-level="14.8" data-path="examples.html"><a href="examples.html#seird"><i class="fa fa-check"></i><b>14.8</b> SEIRD</a></li>
<li class="chapter" data-level="14.9" data-path="examples.html"><a href="examples.html#covid-seir"><i class="fa fa-check"></i><b>14.9</b> Covid SEIR</a></li>
<li class="chapter" data-level="14.10" data-path="examples.html"><a href="examples.html#bc-covid-omicron"><i class="fa fa-check"></i><b>14.10</b> BC Covid Omicron</a></li>
<li class="chapter" data-level="14.11" data-path="examples.html"><a href="examples.html#classic-mcmasterpandemic"><i class="fa fa-check"></i><b>14.11</b> Classic McMasterPandemic</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="troubleshooting.html"><a href="troubleshooting.html"><i class="fa fa-check"></i><b>15</b> Troubleshooting</a><ul>
<li class="chapter" data-level="15.1" data-path="troubleshooting.html"><a href="troubleshooting.html#nan-valued-objective-function"><i class="fa fa-check"></i><b>15.1</b> NaN-Valued Objective Function</a><ul>
<li class="chapter" data-level="15.1.1" data-path="troubleshooting.html"><a href="troubleshooting.html#simulated-time-series-close-to-zero"><i class="fa fa-check"></i><b>15.1.1</b> Simulated time-series close to zero</a></li>
<li class="chapter" data-level="15.1.2" data-path="troubleshooting.html"><a href="troubleshooting.html#negative-rate-matrix-elements"><i class="fa fa-check"></i><b>15.1.2</b> Negative rate matrix elements</a></li>
<li class="chapter" data-level="15.1.3" data-path="troubleshooting.html"><a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters"><i class="fa fa-check"></i><b>15.1.3</b> Optimizer tries very large dispersion parameters</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="troubleshooting.html"><a href="troubleshooting.html#non-positive-definite-covariance-matrix"><i class="fa fa-check"></i><b>15.2</b> Non-Positive Definite Covariance Matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Generalized McMasterPandemic</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="flow-between-states" class="section level1 hasAnchor">
<h1><span class="header-section-number">3</span> Flow Between States<a href="flow-between-states.html#flow-between-states" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Here we describe the definition of the basic model of flows among states. Later chapters describe extensions to this basic model, both implemented (TODO) and unimplemented (TODO).</p>
<p>The per-capita rate of flow between any two states can be defined using the <code>add_rate</code> function.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="flow-between-states.html#cb11-1"></a>sir =<span class="st"> </span>(sir</span>
<span id="cb11-2"><a href="flow-between-states.html#cb11-2"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_rate</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="op">~</span><span class="st"> </span>(I) <span class="op">*</span><span class="st"> </span>(beta) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>N))</span>
<span id="cb11-3"><a href="flow-between-states.html#cb11-3"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_rate</span>(<span class="st">&quot;I&quot;</span>, <span class="st">&quot;R&quot;</span>, <span class="op">~</span><span class="st"> </span>(gamma))</span>
<span id="cb11-4"><a href="flow-between-states.html#cb11-4"></a>)</span></code></pre></div>
<p>The first <code>add_rate</code> function says that on each simulated day, individuals flow from the <code>S</code> box to the <code>I</code> box at a rate equal to the product of <code>I</code>, <code>beta</code>, and <code>1/N</code>. This rate is a per-capita rate, and so the flow of individuals from <code>S</code> to <code>I</code> is <code>S</code> times the rate. Similarly, the second <code>add_rate</code> function says that <code>I</code> times <code>gamma</code> individuals flow from <code>I</code> to <code>R</code> every simulated day.</p>
<p>Here are the rules of these rate formulas (although these can be relaxed to some degree using techniques covered in later chapters).</p>
<ul>
<li>both state variables and parameters can be referred to by name as variables in the formulas</li>
<li>variables must be encapsulated with parentheses</li>
<li>variables can be converted to their inverse <code>(1/x)</code> or complement <code>(1-x)</code></li>
<li>variables, their inverses, and their complements can be combined using <code>+</code> and <code>*</code> operators</li>
</ul>
<p>Examples of valid rate formulas for this model include:</p>
<ul>
<li><code>(1-gamma) * (S) + (gamma)</code></li>
<li><code>(1/I)</code></li>
<li><code>(beta) * (gamma) + (beta) * (1/N) * (1-gamma)</code></li>
</ul>
<p>Examples of invalid rate formulas include:</p>
<ul>
<li><code>1-gamma</code> – no parentheses around this complement</li>
<li><code>beta * gamma</code> – no parentheses around variables (but this can be addressed using <code>struc</code> objects – TODO: link to these)</li>
<li><code>((S) + (R)) * (beta)</code> – general grouping parentheses and common factors are not allowed (but this can be addressed using <code>struc</code> objects or intermediate computations – TODO: link to these)</li>
<li><code>(E) * (beta)</code> – the variable <code>E</code> is in neither the parameter nor state variable</li>
</ul>
<div class="infobox caution">
<p>The remainder of this chapter describes the theory behind these rates, and clarifies what they mean.</p>
<p>To start using this simple SIR model, please move on the the next chapter where you will learn how to do <a href="simulation.html#simulation">Simulation</a> and explore epidemic trajectories.</p>
</div>
<div id="state-flows" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.1</span> State Flows<a href="flow-between-states.html#state-flows" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The numbers of individuals in each compartment is stored in the state vector, <span class="math inline">\(\mathbf{s}\)</span>, which contains one element for each compartment. At each time step, <span class="math inline">\(t\)</span>, the state vector is given by <span class="math inline">\(\mathbf{s}(t)\)</span>. The relationship between the state vector at successive time steps is given by the following.</p>
<p><span class="math display">\[
\mathbf{s}(t+1) = \mathbf{s}(t) + \mathbf{f}^{\text{in}}(t) - \mathbf{f}^{\text{out}}(t)
\]</span></p>
<p>where <span class="math inline">\(\mathbf{f}^{\text{in}}\)</span> and <span class="math inline">\(\mathbf{f}^{\text{out}}\)</span> are the inflow and outflow vectors.</p>
<p>Continuing our concrete SIR model example, individuals flow from a box of susceptible individuals to infected to recovered individuals.</p>
<p><span class="math display">\[
S(t+1) = S(t) - \frac{\beta I(t)}{N}S(t)
\]</span>
<span class="math display">\[
I(t+1) = I(t) + \frac{\beta I(t)}{N}S(t) - \gamma I(t)
\]</span>
<span class="math display">\[
R(t+1) = R(t) + \gamma I(t)
\]</span></p>
<p>where <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\gamma\)</span>, and <span class="math inline">\(N\)</span> are the transmission rate and population size parameters.</p>
<p>In this model the inflow to the <span class="math inline">\(S\)</span> box is zero and the outflow from <span class="math inline">\(R\)</span> is also zero. Therefore we can express this model in general terms as the following.</p>
<p><span class="math display">\[
\mathbf{s} =
\begin{bmatrix}
S \\ I \\ R
\end{bmatrix}
\]</span>
<span class="math display">\[
\mathbf{f}^{\text{in}} = 
\begin{bmatrix}
0 \\ \frac{\beta I S}{N} \\ \gamma I
\end{bmatrix}
\]</span>
<span class="math display">\[
\mathbf{f}^{\text{out}} = 
\begin{bmatrix}
\frac{\beta I S}{N} \\ \gamma I \\ 0
\end{bmatrix}
\]</span></p>
</div>
<div id="flow-matrix" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.2</span> Flow Matrix<a href="flow-between-states.html#flow-matrix" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note that the outflow from <span class="math inline">\(S\)</span> and inflow to <span class="math inline">\(I\)</span> in the previous example has an identical magnitude. This is a common pattern in compartmental models. Many outflows are balanced perfectly by an associated inflow, to model individuals flowing from one compartment to another. McMasterPandemic assumes this balancing of flows to be the default situation, and therefore expresses both inflows and outflows in terms of an <span class="math inline">\(n\)</span> by <span class="math inline">\(n\)</span> flow matrix, <span class="math inline">\(\mathbf{F}\)</span>, that only requires specifying a single expression for each inflow-outflow pair. The element in the <span class="math inline">\(i\)</span>th row and <span class="math inline">\(j\)</span>th column of the flow matrix gives the flow from state <span class="math inline">\(i\)</span> to state <span class="math inline">\(j\)</span>. The default inflow and outflow vectors can therefore be computed as the column sums and row sums respectively. Continuing the SI model example, we have the following flow matrix.</p>
<p><span class="math display">\[
\mathbf{F} = 
\begin{bmatrix}
0 &amp; \frac{\beta I}{N}S &amp; 0 \\
0 &amp; 0 &amp; \gamma I \\
0 &amp; 0 &amp; 0 \\
\end{bmatrix}
\]</span></p>
<p>There are times however where one wants a particular flow from one state to another to include only the inflow component and not the outflow. For example in cases where death removes individuals from the population. We consider this and other examples of asymmetric flow in later chapters (TODO).</p>
</div>
<div id="rate-matrix" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.3</span> Rate Matrix<a href="flow-between-states.html#rate-matrix" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In modelling it is often more convenient to define per-capita rates of flow between compartments rather than total flow. The rate matrix, <span class="math inline">\(\mathbf{M}\)</span>, contains these per-capita rates. The elements, <span class="math inline">\(F_{ij}\)</span>, of the flow matrix can be computed from the rate matrix and the state vector as follows.</p>
<p><span class="math display">\[
F_{ij} = M_{ij}s_i
\]</span></p>
<p>The rate matrix for the SI model is given by the following expression.</p>
<p><span class="math display">\[
\mathbf{M} = 
\begin{bmatrix}
0 &amp; \frac{\beta I}{N} &amp; 0 \\
0 &amp; 0 &amp; \gamma \\
0 &amp; 0 &amp; 0 
\end{bmatrix}
\]</span></p>
<p>The elements of the rate matrix are determined by expressions involving elements of the state vector and parameters, which we collect into a paramter vector, <span class="math inline">\(\mathbf{\theta}\)</span>. For the SI model <span class="math inline">\(\mathbf{\theta}\)</span> contains two parameters.</p>
<p><span class="math display">\[
\mathbf{\theta} = \begin{bmatrix}
\beta \\
\gamma \\
N
\end{bmatrix}
\]</span></p>
</div>
<div id="rate-matrix-dependence-on-state-variables-and-parameters" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.4</span> Rate Matrix Dependence on State Variables and Parameters<a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Currently it is not possible to specify elements of the rate matrix as arbitrary arithmetic expressions involving state variables and parameters – although we plan to add this functionality. However, there is a reasonable degree of flexibility.</p>
<p>Each element of the rate matrix can be any expression that obeys the following rules. Any element, <span class="math inline">\(x\)</span>, of either the parameter or state vector can be used to define a <em>factor</em> in one of the following three forms.</p>
<ul>
<li>Identity: <span class="math inline">\(x\)</span></li>
<li>Complement: <span class="math inline">\(1-x\)</span></li>
<li>Inverse: <span class="math inline">\(1/x\)</span></li>
</ul>
<p>We collect these user-defined factors into a factor vector, <span class="math inline">\(\mathbf{y}\)</span>. Factors can be repeated in <span class="math inline">\(\mathbf{y}\)</span> if required. Any number of factors can be multiplied together using <code>*</code> to produce a <em>product</em>. Any number of factors and products can be added together using <code>+</code>.</p>
<p>There is the following higher level nested structure associated with the factor vector, <span class="math inline">\(\mathbf{y}\)</span>.</p>
<ul>
<li>All factors associated with the, <span class="math inline">\(i\)</span>th, non-zero rate matrix element, <span class="math inline">\(M_{(i)}\)</span>, are grouped together in a contiguous block within <span class="math inline">\(\mathbf{y}\)</span></li>
<li>Within the <span class="math inline">\(i\)</span>th block, all factors associated with the <span class="math inline">\(j\)</span>th product (<span class="math inline">\(j = 1 ... n_i\)</span>) in that block are grouped together in a contiguous sub-block</li>
<li>Within the <span class="math inline">\(i,j\)</span>th sub-block, all factors are given an index, <span class="math inline">\(k = 1 ... m_{ij}\)</span></li>
</ul>
<p>With these definitions, the dependence of any non-zero rate matrix element on the parameters and state variables is given by the following expression.</p>
<p><span class="math display">\[
M_{(i)} = \sum_{j=1}^{n_i} \prod_{k=1}^{m_{ij}} y_{ijk}
\]</span></p>
<p>where <span class="math inline">\(y_{ijk}\)</span> is the <span class="math inline">\(k\)</span>th factor associated with the <span class="math inline">\(j\)</span>th product associated with the <span class="math inline">\(i\)</span>th non-zero rate matrix element.</p>
<table>
<thead>
<tr class="header">
<th align="left">from</th>
<th align="left">to</th>
<th align="right">n-fctrs</th>
<th align="right">n-prdcts</th>
<th align="right">n-vrbls</th>
<th align="left">state-dependent</th>
<th align="left">time-varying</th>
<th align="left">sum-dependent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">S</td>
<td align="left">I</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="left">TRUE</td>
<td align="left">FALSE</td>
<td align="left">FALSE</td>
</tr>
<tr class="even">
<td align="left">I</td>
<td align="left">R</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="left">FALSE</td>
<td align="left">FALSE</td>
</tr>
</tbody>
</table>
<p>McMasterPandemic is designed to be modular and allow multiple definitions of valid expressions for the rate matrix. In later chapters we describe this possibility (TODO).</p>
</div>
<div id="connections-with-classic-mcmasterpandemic" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.5</span> Connections with Classic McMasterPandemic<a href="flow-between-states.html#connections-with-classic-mcmasterpandemic" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="flow-between-states.html#cb12-1"></a>params &lt;-<span class="st"> </span><span class="kw">read_params</span>(<span class="st">&quot;ICU1.csv&quot;</span>)</span>
<span id="cb12-2"><a href="flow-between-states.html#cb12-2"></a>classic_macpan =<span class="st"> </span><span class="kw">make_base_model</span>(</span>
<span id="cb12-3"><a href="flow-between-states.html#cb12-3"></a>  <span class="dt">params =</span> params,  <span class="dt">state =</span> <span class="ot">NULL</span>,</span>
<span id="cb12-4"><a href="flow-between-states.html#cb12-4"></a>  <span class="dt">start_date =</span> <span class="st">&quot;2021-09-10&quot;</span>,</span>
<span id="cb12-5"><a href="flow-between-states.html#cb12-5"></a>  <span class="dt">end_date =</span> <span class="st">&quot;2021-10-10&quot;</span></span>
<span id="cb12-6"><a href="flow-between-states.html#cb12-6"></a>)</span>
<span id="cb12-7"><a href="flow-between-states.html#cb12-7"></a>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">rate_summary</span>(classic_macpan, <span class="dt">include_parse_info =</span> <span class="ot">FALSE</span>))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">from</th>
<th align="left">to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">E_to_Ia</td>
<td align="left">E</td>
<td align="left">Ia</td>
</tr>
<tr class="even">
<td align="left">E_to_Ip</td>
<td align="left">E</td>
<td align="left">Ip</td>
</tr>
<tr class="odd">
<td align="left">Ia_to_R</td>
<td align="left">Ia</td>
<td align="left">R</td>
</tr>
<tr class="even">
<td align="left">Ip_to_Im</td>
<td align="left">Ip</td>
<td align="left">Im</td>
</tr>
<tr class="odd">
<td align="left">Ip_to_Is</td>
<td align="left">Ip</td>
<td align="left">Is</td>
</tr>
<tr class="even">
<td align="left">Im_to_R</td>
<td align="left">Im</td>
<td align="left">R</td>
</tr>
<tr class="odd">
<td align="left">Is_to_H</td>
<td align="left">Is</td>
<td align="left">H</td>
</tr>
<tr class="even">
<td align="left">Is_to_ICUs</td>
<td align="left">Is</td>
<td align="left">ICUs</td>
</tr>
<tr class="odd">
<td align="left">Is_to_ICUd</td>
<td align="left">Is</td>
<td align="left">ICUd</td>
</tr>
<tr class="even">
<td align="left">Is_to_D</td>
<td align="left">Is</td>
<td align="left">D</td>
</tr>
<tr class="odd">
<td align="left">ICUs_to_H2</td>
<td align="left">ICUs</td>
<td align="left">H2</td>
</tr>
<tr class="even">
<td align="left">ICUd_to_D</td>
<td align="left">ICUd</td>
<td align="left">D</td>
</tr>
<tr class="odd">
<td align="left">H2_to_R</td>
<td align="left">H2</td>
<td align="left">R</td>
</tr>
<tr class="even">
<td align="left">H_to_R</td>
<td align="left">H</td>
<td align="left">R</td>
</tr>
<tr class="odd">
<td align="left">Is_to_X</td>
<td align="left">Is</td>
<td align="left">X</td>
</tr>
<tr class="even">
<td align="left">S_to_E</td>
<td align="left">S</td>
<td align="left">E</td>
</tr>
</tbody>
</table>
</div>
<div id="topological-sort" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.6</span> Topological Sort<a href="flow-between-states.html#topological-sort" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="flow-between-states.html#cb13-1"></a>knitr<span class="op">::</span><span class="kw">kable</span>(classic_macpan</span>
<span id="cb13-2"><a href="flow-between-states.html#cb13-2"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rate_summary</span>(<span class="dt">include_parse_info =</span> <span class="ot">FALSE</span>)</span>
<span id="cb13-3"><a href="flow-between-states.html#cb13-3"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">from =</span> <span class="kw">factor</span>(from, <span class="kw">topological_sort</span>(classic_macpan)))</span>
<span id="cb13-4"><a href="flow-between-states.html#cb13-4"></a> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(from)</span>
<span id="cb13-5"><a href="flow-between-states.html#cb13-5"></a>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">from</th>
<th align="left">to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">S_to_E</td>
<td align="left">S</td>
<td align="left">E</td>
</tr>
<tr class="even">
<td align="left">E_to_Ia</td>
<td align="left">E</td>
<td align="left">Ia</td>
</tr>
<tr class="odd">
<td align="left">E_to_Ip</td>
<td align="left">E</td>
<td align="left">Ip</td>
</tr>
<tr class="even">
<td align="left">Ia_to_R</td>
<td align="left">Ia</td>
<td align="left">R</td>
</tr>
<tr class="odd">
<td align="left">Ip_to_Im</td>
<td align="left">Ip</td>
<td align="left">Im</td>
</tr>
<tr class="even">
<td align="left">Ip_to_Is</td>
<td align="left">Ip</td>
<td align="left">Is</td>
</tr>
<tr class="odd">
<td align="left">Im_to_R</td>
<td align="left">Im</td>
<td align="left">R</td>
</tr>
<tr class="even">
<td align="left">Is_to_H</td>
<td align="left">Is</td>
<td align="left">H</td>
</tr>
<tr class="odd">
<td align="left">Is_to_ICUs</td>
<td align="left">Is</td>
<td align="left">ICUs</td>
</tr>
<tr class="even">
<td align="left">Is_to_ICUd</td>
<td align="left">Is</td>
<td align="left">ICUd</td>
</tr>
<tr class="odd">
<td align="left">Is_to_D</td>
<td align="left">Is</td>
<td align="left">D</td>
</tr>
<tr class="even">
<td align="left">Is_to_X</td>
<td align="left">Is</td>
<td align="left">X</td>
</tr>
<tr class="odd">
<td align="left">H_to_R</td>
<td align="left">H</td>
<td align="left">R</td>
</tr>
<tr class="even">
<td align="left">ICUs_to_H2</td>
<td align="left">ICUs</td>
<td align="left">H2</td>
</tr>
<tr class="odd">
<td align="left">ICUd_to_D</td>
<td align="left">ICUd</td>
<td align="left">D</td>
</tr>
<tr class="even">
<td align="left">H2_to_R</td>
<td align="left">H2</td>
<td align="left">R</td>
</tr>
</tbody>
</table>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="simple-model-initialization.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="simulation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/canmod/macpan-book/edit/main/02-flows.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
