<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>16 Troubleshooting | Generalized McMasterPandemic</title>
  <meta name="description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="16 Troubleshooting | Generalized McMasterPandemic" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  <meta name="github-repo" content="canmod/macpan-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="16 Troubleshooting | Generalized McMasterPandemic" />
  
  <meta name="twitter:description" content="McMasterPandemic is a modelling tool that was rapidly developed to provide timely insights into the Covid-19 Pandemic in Canada. We are currently refactoring this tool so that it is faster and more general. This guide describes how to use this refactored version of McMasterPandemic." />
  

<meta name="author" content="Steve Walker" />


<meta name="date" content="2022-06-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="examples.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet" />
<script src="libs/vis-9.1.0/vis-network.min.js"></script>
<script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">McMasterPandemic</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Fast and Flexible Modelling with McMasterPandemic</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#history-and-motivation"><i class="fa fa-check"></i><b>1.1</b> History and Motivation</a><ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#covid-19-forecasts"><i class="fa fa-check"></i><b>1.1.1</b> COVID-19 Forecasts</a></li>
<li class="chapter" data-level="1.1.2" data-path="index.html"><a href="index.html#calibration-to-data"><i class="fa fa-check"></i><b>1.1.2</b> Calibration to data</a></li>
<li class="chapter" data-level="1.1.3" data-path="index.html"><a href="index.html#speed"><i class="fa fa-check"></i><b>1.1.3</b> Speed</a></li>
<li class="chapter" data-level="1.1.4" data-path="index.html"><a href="index.html#model-extensibility"><i class="fa fa-check"></i><b>1.1.4</b> Model Extensibility</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.2</b> Installation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dependencies"><i class="fa fa-check"></i><b>1.3</b> Dependencies</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#generalized-model-at-a-glance"><i class="fa fa-check"></i><b>1.4</b> Generalized Model at a Glance</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="model-initialization.html"><a href="model-initialization.html"><i class="fa fa-check"></i><b>2</b> Model Initialization</a><ul>
<li class="chapter" data-level="2.1" data-path="model-initialization.html"><a href="model-initialization.html#initial-parameter-vector"><i class="fa fa-check"></i><b>2.1</b> Initial Parameter Vector</a></li>
<li class="chapter" data-level="2.2" data-path="model-initialization.html"><a href="model-initialization.html#initial-state-vector"><i class="fa fa-check"></i><b>2.2</b> Initial State Vector</a></li>
<li class="chapter" data-level="2.3" data-path="model-initialization.html"><a href="model-initialization.html#start-and-end-date"><i class="fa fa-check"></i><b>2.3</b> Start and End Date</a></li>
<li class="chapter" data-level="2.4" data-path="model-initialization.html"><a href="model-initialization.html#next-steps"><i class="fa fa-check"></i><b>2.4</b> Next Steps</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="flow-between-states.html"><a href="flow-between-states.html"><i class="fa fa-check"></i><b>3</b> Flow Between States</a><ul>
<li class="chapter" data-level="3.1" data-path="flow-between-states.html"><a href="flow-between-states.html#state-flows"><i class="fa fa-check"></i><b>3.1</b> State Flows</a></li>
<li class="chapter" data-level="3.2" data-path="flow-between-states.html"><a href="flow-between-states.html#flow-matrix"><i class="fa fa-check"></i><b>3.2</b> Flow Matrix</a></li>
<li class="chapter" data-level="3.3" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix"><i class="fa fa-check"></i><b>3.3</b> Rate Matrix</a></li>
<li class="chapter" data-level="3.4" data-path="flow-between-states.html"><a href="flow-between-states.html#rate-matrix-dependence-on-state-variables-and-parameters"><i class="fa fa-check"></i><b>3.4</b> Rate Matrix Dependence on State Variables and Parameters</a></li>
<li class="chapter" data-level="3.5" data-path="flow-between-states.html"><a href="flow-between-states.html#connections-with-classic-mcmasterpandemic"><i class="fa fa-check"></i><b>3.5</b> Connections with Classic McMasterPandemic</a></li>
<li class="chapter" data-level="3.6" data-path="flow-between-states.html"><a href="flow-between-states.html#topological-sort"><i class="fa fa-check"></i><b>3.6</b> Topological Sort</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="simulation.html"><a href="simulation.html"><i class="fa fa-check"></i><b>4</b> Simulation</a><ul>
<li class="chapter" data-level="4.1" data-path="simulation.html"><a href="simulation.html#observation-error"><i class="fa fa-check"></i><b>4.1</b> Observation Error</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="calibration.html"><a href="calibration.html"><i class="fa fa-check"></i><b>5</b> Calibration</a><ul>
<li class="chapter" data-level="5.1" data-path="calibration.html"><a href="calibration.html#calibrating-with-observation-error"><i class="fa fa-check"></i><b>5.1</b> Calibrating with Observation Error</a></li>
<li class="chapter" data-level="5.2" data-path="calibration.html"><a href="calibration.html#loss-function-theory"><i class="fa fa-check"></i><b>5.2</b> Loss Function Theory</a><ul>
<li class="chapter" data-level="5.2.1" data-path="calibration.html"><a href="calibration.html#negative-binomial"><i class="fa fa-check"></i><b>5.2.1</b> Negative Binomial</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="convergence.html"><a href="convergence.html"><i class="fa fa-check"></i><b>6</b> Convergence</a></li>
<li class="chapter" data-level="7" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html"><i class="fa fa-check"></i><b>7</b> Time Varying Parameters</a><ul>
<li class="chapter" data-level="7.1" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#model-of-piece-wise-time-variation"><i class="fa fa-check"></i><b>7.1</b> Model of Piece-Wise Time-Variation</a></li>
<li class="chapter" data-level="7.2" data-path="time-varying-parameters.html"><a href="time-varying-parameters.html#calibrating-time-variation-schedules"><i class="fa fa-check"></i><b>7.2</b> Calibrating Time-Variation Schedules</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="other-variables.html"><a href="other-variables.html"><i class="fa fa-check"></i><b>8</b> Other Variables</a><ul>
<li class="chapter" data-level="8.1" data-path="other-variables.html"><a href="other-variables.html#intermediate-results"><i class="fa fa-check"></i><b>8.1</b> Intermediate Results</a><ul>
<li class="chapter" data-level="8.1.1" data-path="other-variables.html"><a href="other-variables.html#sums-of-state-variables-and-parameters"><i class="fa fa-check"></i><b>8.1.1</b> Sums of State Variables and Parameters</a></li>
<li class="chapter" data-level="8.1.2" data-path="other-variables.html"><a href="other-variables.html#factrs"><i class="fa fa-check"></i><b>8.1.2</b> Factrs</a></li>
<li class="chapter" data-level="8.1.3" data-path="other-variables.html"><a href="other-variables.html#power-laws"><i class="fa fa-check"></i><b>8.1.3</b> Power Laws</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="other-variables.html"><a href="other-variables.html#additional-variables-in-the-simulation-history"><i class="fa fa-check"></i><b>8.2</b> Additional Variables in the Simulation History</a><ul>
<li class="chapter" data-level="8.2.1" data-path="other-variables.html"><a href="other-variables.html#simulation-history-expressions"><i class="fa fa-check"></i><b>8.2.1</b> Simulation History Expressions</a></li>
<li class="chapter" data-level="8.2.2" data-path="other-variables.html"><a href="other-variables.html#lagged-differencing"><i class="fa fa-check"></i><b>8.2.2</b> Lagged Differencing</a></li>
<li class="chapter" data-level="8.2.3" data-path="other-variables.html"><a href="other-variables.html#convolutions"><i class="fa fa-check"></i><b>8.2.3</b> Convolutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html"><i class="fa fa-check"></i><b>9</b> Ensemble Forecasts</a><ul>
<li class="chapter" data-level="9.1" data-path="ensemble-forecasts.html"><a href="ensemble-forecasts.html#time-varying-ensemble-forecasts"><i class="fa fa-check"></i><b>9.1</b> Time-Varying Ensemble Forecasts</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>10</b> Vectors</a></li>
<li class="chapter" data-level="11" data-path="hazard-smoothing.html"><a href="hazard-smoothing.html"><i class="fa fa-check"></i><b>11</b> Hazard Smoothing</a></li>
<li class="chapter" data-level="12" data-path="state-initialization.html"><a href="state-initialization.html"><i class="fa fa-check"></i><b>12</b> State Initialization</a></li>
<li class="chapter" data-level="13" data-path="outflows.html"><a href="outflows.html"><i class="fa fa-check"></i><b>13</b> Outflows</a><ul>
<li class="chapter" data-level="13.1" data-path="outflows.html"><a href="outflows.html#accumulators"><i class="fa fa-check"></i><b>13.1</b> Accumulators</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="tmb-engine.html"><a href="tmb-engine.html"><i class="fa fa-check"></i><b>14</b> TMB Engine</a></li>
<li class="chapter" data-level="15" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>15</b> Examples</a><ul>
<li class="chapter" data-level="15.1" data-path="examples.html"><a href="examples.html#hello-world-simulating-an-sir-model"><i class="fa fa-check"></i><b>15.1</b> Hello World: Simulating an SIR Model</a></li>
<li class="chapter" data-level="15.2" data-path="examples.html"><a href="examples.html#si"><i class="fa fa-check"></i><b>15.2</b> SI</a></li>
<li class="chapter" data-level="15.3" data-path="examples.html"><a href="examples.html#seir"><i class="fa fa-check"></i><b>15.3</b> SEIR</a></li>
<li class="chapter" data-level="15.4" data-path="examples.html"><a href="examples.html#structure-two-strain-sir"><i class="fa fa-check"></i><b>15.4</b> Structure: Two-Strain SIR</a></li>
<li class="chapter" data-level="15.5" data-path="examples.html"><a href="examples.html#erlang-seir"><i class="fa fa-check"></i><b>15.5</b> Erlang SEIR</a></li>
<li class="chapter" data-level="15.6" data-path="examples.html"><a href="examples.html#sirv"><i class="fa fa-check"></i><b>15.6</b> SIRV</a></li>
<li class="chapter" data-level="15.7" data-path="examples.html"><a href="examples.html#variolation-model"><i class="fa fa-check"></i><b>15.7</b> Variolation model</a></li>
<li class="chapter" data-level="15.8" data-path="examples.html"><a href="examples.html#seird"><i class="fa fa-check"></i><b>15.8</b> SEIRD</a></li>
<li class="chapter" data-level="15.9" data-path="examples.html"><a href="examples.html#covid-seir"><i class="fa fa-check"></i><b>15.9</b> Covid SEIR</a></li>
<li class="chapter" data-level="15.10" data-path="examples.html"><a href="examples.html#bc-covid-omicron"><i class="fa fa-check"></i><b>15.10</b> BC Covid Omicron</a></li>
<li class="chapter" data-level="15.11" data-path="examples.html"><a href="examples.html#classic-mcmasterpandemic"><i class="fa fa-check"></i><b>15.11</b> Classic McMasterPandemic</a></li>
<li class="chapter" data-level="15.12" data-path="examples.html"><a href="examples.html#granich-hiv-model"><i class="fa fa-check"></i><b>15.12</b> Granich HIV Model</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="troubleshooting.html"><a href="troubleshooting.html"><i class="fa fa-check"></i><b>16</b> Troubleshooting</a><ul>
<li class="chapter" data-level="16.1" data-path="troubleshooting.html"><a href="troubleshooting.html#nan-valued-objective-function"><i class="fa fa-check"></i><b>16.1</b> NaN-Valued Objective Function</a><ul>
<li class="chapter" data-level="16.1.1" data-path="troubleshooting.html"><a href="troubleshooting.html#simulated-time-series-close-to-zero"><i class="fa fa-check"></i><b>16.1.1</b> Simulated time-series close to zero</a></li>
<li class="chapter" data-level="16.1.2" data-path="troubleshooting.html"><a href="troubleshooting.html#negative-rate-matrix-elements"><i class="fa fa-check"></i><b>16.1.2</b> Negative rate matrix elements</a></li>
<li class="chapter" data-level="16.1.3" data-path="troubleshooting.html"><a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters"><i class="fa fa-check"></i><b>16.1.3</b> Optimizer tries very large dispersion parameters</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="troubleshooting.html"><a href="troubleshooting.html#non-positive-definite-covariance-matrix"><i class="fa fa-check"></i><b>16.2</b> Non-Positive Definite Covariance Matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Generalized McMasterPandemic</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="troubleshooting" class="section level1 hasAnchor">
<h1><span class="header-section-number">16</span> Troubleshooting<a href="troubleshooting.html#troubleshooting" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="nan-valued-objective-function" class="section level2 hasAnchor">
<h2><span class="header-section-number">16.1</span> NaN-Valued Objective Function<a href="troubleshooting.html#nan-valued-objective-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="simulated-time-series-close-to-zero" class="section level3 hasAnchor">
<h3><span class="header-section-number">16.1.1</span> Simulated time-series close to zero<a href="troubleshooting.html#simulated-time-series-close-to-zero" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When the simulated values that are being compared with data are close to zero (e.g. less than 1e-12), the negative binomial loss function often returns NaN. This can be fixed by setting <code>do_sim_constraint = TRUE</code> as an argument to <code>flexmodel</code> or whatever model constructor is being used (e.g. <code>make_vaccination_model</code>). This flag causes the simulated values to pass through the following soft-thresholding function to keep the simulations, <span class="math inline">\(x\)</span>, from falling below a tolerance, <span class="math inline">\(\epsilon\)</span>.</p>
<p><span class="math display">\[
x + \frac{\epsilon}{1-(x-\epsilon)/\epsilon + (x-\epsilon)^2/\epsilon^2}
\]</span></p>
<p>This tolerance can be adjusted by setting the <code>sim_lower_bound = 1e-12</code>. Note that both <code>do_sim_constraint</code> and <code>sim_lower_bound</code> can be set using the global options <code>MP_default_do_sim_constraint</code> and <code>MP_default_sim_lower_bound</code>.</p>
</div>
<div id="negative-rate-matrix-elements" class="section level3 hasAnchor">
<h3><span class="header-section-number">16.1.2</span> Negative rate matrix elements<a href="troubleshooting.html#negative-rate-matrix-elements" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>These can arise naturally due to time-varying parameters that appear in <code>1-x</code> terms in rate formulas. The best way to avoid this is to use the <code>abs</code> type of time-variation, so that logit transformations can be used directly on the changing parameters. This approach ensures that the parameter never leaves the interval between zero and one. It is also possible to update changing parameters on the logit scale, which would also solve this problem. See the <a href="time-varying-parameters.html#model-of-piece-wise-time-variation">Model of Piece-Wise Time-Variation</a> for more details.</p>
<p>To illustrate this use of the logit-scale time-variation model, we use a modified SIR model in which a certain proportion of infected individuals die at the end of the infection period. This proportion is increased at April 1 by three-times the previous value.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="troubleshooting.html#cb117-1"></a>sir_with_death =<span class="st"> </span>(</span>
<span id="cb117-2"><a href="troubleshooting.html#cb117-2"></a>  <span class="kw">flexmodel</span>(</span>
<span id="cb117-3"><a href="troubleshooting.html#cb117-3"></a>    <span class="dt">params =</span> <span class="kw">c</span>(</span>
<span id="cb117-4"><a href="troubleshooting.html#cb117-4"></a>      <span class="dt">tau =</span> <span class="dv">16</span>,    <span class="co"># infected period</span></span>
<span id="cb117-5"><a href="troubleshooting.html#cb117-5"></a>      <span class="dt">beta =</span> <span class="fl">0.15</span>, <span class="co"># transmssion rate</span></span>
<span id="cb117-6"><a href="troubleshooting.html#cb117-6"></a>      <span class="dt">p =</span> <span class="fl">0.2</span>      <span class="co"># proportion who die at the end of the infected period</span></span>
<span id="cb117-7"><a href="troubleshooting.html#cb117-7"></a>    ),</span>
<span id="cb117-8"><a href="troubleshooting.html#cb117-8"></a>    <span class="dt">state =</span> <span class="kw">c</span>(<span class="dt">S =</span> <span class="dv">20000</span>, <span class="dt">I =</span> <span class="dv">100</span>, <span class="dt">R =</span> <span class="dv">0</span>, <span class="dt">D =</span> <span class="dv">0</span>),</span>
<span id="cb117-9"><a href="troubleshooting.html#cb117-9"></a>    <span class="dt">start_date =</span> <span class="st">&quot;2000-01-01&quot;</span>,</span>
<span id="cb117-10"><a href="troubleshooting.html#cb117-10"></a>    <span class="dt">end_date =</span> <span class="st">&quot;2000-05-01&quot;</span>,</span>
<span id="cb117-11"><a href="troubleshooting.html#cb117-11"></a>    <span class="dt">do_hazard =</span> <span class="ot">TRUE</span></span>
<span id="cb117-12"><a href="troubleshooting.html#cb117-12"></a>  )</span>
<span id="cb117-13"><a href="troubleshooting.html#cb117-13"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_state_param_sum</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;^(S|I|R)$&quot;</span>)</span>
<span id="cb117-14"><a href="troubleshooting.html#cb117-14"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_rate</span>(<span class="st">&quot;S&quot;</span>, <span class="st">&quot;I&quot;</span>, <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>N) <span class="op">*</span><span class="st"> </span>(beta) <span class="op">*</span><span class="st"> </span>(I))</span>
<span id="cb117-15"><a href="troubleshooting.html#cb117-15"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_rate</span>(<span class="st">&quot;I&quot;</span>, <span class="st">&quot;R&quot;</span>, <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>tau) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>p))</span>
<span id="cb117-16"><a href="troubleshooting.html#cb117-16"></a>  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_rate</span>(<span class="st">&quot;I&quot;</span>, <span class="st">&quot;D&quot;</span>, <span class="op">~</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>tau) <span class="op">*</span><span class="st"> </span>(p))</span>
<span id="cb117-17"><a href="troubleshooting.html#cb117-17"></a>)</span>
<span id="cb117-18"><a href="troubleshooting.html#cb117-18"></a></span>
<span id="cb117-19"><a href="troubleshooting.html#cb117-19"></a>plot_with_death_rates =<span class="st"> </span><span class="cf">function</span>(value, type) {</span>
<span id="cb117-20"><a href="troubleshooting.html#cb117-20"></a>  (sir_with_death</span>
<span id="cb117-21"><a href="troubleshooting.html#cb117-21"></a>    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_piece_wise</span>(</span>
<span id="cb117-22"><a href="troubleshooting.html#cb117-22"></a>      <span class="kw">data.frame</span>(</span>
<span id="cb117-23"><a href="troubleshooting.html#cb117-23"></a>        <span class="dt">Date =</span> <span class="st">&quot;2000-04-01&quot;</span>,</span>
<span id="cb117-24"><a href="troubleshooting.html#cb117-24"></a>        <span class="dt">Symbol =</span> <span class="st">&quot;p&quot;</span>,</span>
<span id="cb117-25"><a href="troubleshooting.html#cb117-25"></a>        <span class="dt">Value =</span> value,</span>
<span id="cb117-26"><a href="troubleshooting.html#cb117-26"></a>        <span class="dt">Type =</span> type</span>
<span id="cb117-27"><a href="troubleshooting.html#cb117-27"></a>    ))</span>
<span id="cb117-28"><a href="troubleshooting.html#cb117-28"></a>    <span class="op">%&gt;%</span><span class="st"> </span>simulation_history</span>
<span id="cb117-29"><a href="troubleshooting.html#cb117-29"></a>    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="op">-</span>Date, <span class="dt">names_to =</span> <span class="st">&quot;rate&quot;</span>)</span>
<span id="cb117-30"><a href="troubleshooting.html#cb117-30"></a>    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;_to_&quot;</span>, rate))</span>
<span id="cb117-31"><a href="troubleshooting.html#cb117-31"></a>    <span class="op">%&gt;%</span><span class="st"> </span>ggplot</span>
<span id="cb117-32"><a href="troubleshooting.html#cb117-32"></a>    <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(Date, value, <span class="dt">colour =</span> rate))</span>
<span id="cb117-33"><a href="troubleshooting.html#cb117-33"></a>  )</span>
<span id="cb117-34"><a href="troubleshooting.html#cb117-34"></a>}</span>
<span id="cb117-35"><a href="troubleshooting.html#cb117-35"></a><span class="kw">plot_with_death_rates</span>(<span class="dv">3</span>, <span class="st">&#39;rel_prev&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/negative_rate_avoidance-1.png" width="672" /></p>
<p>In this example the rate at which infected individuals die becomes higher on April 1. This increase necessarily corresponds to a drop in the rate at which infected individuals live, but the drop does not push the rate below zero in this case. But importantly there are no structural restrictions that keep the rates positive when the <code>'rel_prev'</code> method is used. We can illustrate this by increasing the multiplier from three to six.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="troubleshooting.html#cb118-1"></a><span class="kw">plot_with_death_rates</span>(<span class="dv">6</span>, <span class="st">&#39;rel_prev&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/negative_rates-1.png" width="672" /></p>
<p>Note that we have suppressed warnings about negative rates, which are clearly visible on the plot above. These negative rates can be completely avoided by specifying the increase on the logit scale with the <code>'rel_prev_logit'</code> type.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="troubleshooting.html#cb119-1"></a><span class="kw">plot_with_death_rates</span>(<span class="dv">6</span>, <span class="st">&#39;rel_prev_logit&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/avoid_negative_rates-1.png" width="672" /></p>
<p>This means that the log-odds of death after infection additively increases by six on April 1. The log odds could be made as high as one wants, and the rate at which infected individuals live would never drop below zero.</p>
</div>
<div id="optimizer-tries-very-large-dispersion-parameters" class="section level3 hasAnchor">
<h3><span class="header-section-number">16.1.3</span> Optimizer tries very large dispersion parameters<a href="troubleshooting.html#optimizer-tries-very-large-dispersion-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For some reason the TMB <code>dnbinom2</code> function cannot handle large dispersion parameters, even though the standard R <code>dnbinom</code> function seems fine with them. Nevertheless, this entire issue can be avoided by setting priors on the dispersion parameters. In the future we might try to exploit the fact that the limit of the log negative binomial density as the dispersion parameter gets large tends to the log poisson density. Such an improvement is not entirely trivial due to the need for maintaining differentiability.</p>
</div>
</div>
<div id="non-positive-definite-covariance-matrix" class="section level2 hasAnchor">
<h2><span class="header-section-number">16.2</span> Non-Positive Definite Covariance Matrix<a href="troubleshooting.html#non-positive-definite-covariance-matrix" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When generating ensemble forecasts …</p>
<p>Use <code>PDify = TRUE</code> …</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="examples.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/canmod/macpan-book/edit/main/15-troubleshooting.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
